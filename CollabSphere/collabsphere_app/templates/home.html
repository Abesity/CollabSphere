{% extends "base_dashboard.html" %}
{% load static %}

{% block title %}Home â€“ CollabSphere{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/sidebar.css' %}?v=1.0">
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=1.0">
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/sidebar.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid dashboard-container">

  <!-- Main Content -->
  <main class="dashboard-main">
    
    <!-- Welcome Section -->
    <section class="welcome-text">
      <h1>{{ greeting }}, {{ user_name|default:"User" }}!</h1>
      <p>{{ team_message|default:"Here's what's happening with your team today." }}</p>
    </section>

    <!-- Summary Cards -->
    <section class="summary-cards">
      <div class="card summary">
        <div class="card-content">
          <div class="card-text">
            <h3>Active Tasks</h3>
            <p class="number">{{ active_tasks|default:"0" }}</p>
          </div>
          <div class="card-icon">
            <img src="{% static 'images/tasks.png' %}" alt="Tasks Icon">
          </div>
        </div>
      </div>

      <div class="card summary">
        <div class="card-content">
          <div class="card-text">
            <h3>Team Members</h3>
            <p class="number">{{ team_members_count|default:"0" }}</p>
          </div>
          <div class="card-icon">
            <img src="{% static 'images/members.png' %}" alt="Members Icon">
          </div>
        </div>
      </div>

      <div class="card summary">
        <div class="card-content">
          <div class="card-text">
            <h3>Productivity</h3>
            <p class="number">{{ productivity|default:"0%" }}</p>
          </div>
          <div class="card-icon">
            <img src="{% static 'images/productivity.png' %}" alt="Productivity Icon">
          </div>
        </div>
      </div>
    </section>

    <!-- Bottom Grid -->
    <section class="bottom-grid">
      
      <!-- Left Column: Tasks -->
      <div class="column-left">
        <div class="card tasks">
          <div class="card-header">
            <h3>My Tasks</h3>
            <button class="btn-new" id="openTaskModal">+ New Task</button>
          </div>
          <div id="taskModalContainer"></div>  
          <ul class="task-list">
            {% for task in tasks %}
            <li class="task-item">
              <span>{{ task.icon|default:"ðŸ“„" }} {{ task.title|default:"Untitled Task" }}</span>
              <span class="task-label {{ task.priority|default:"medium" }}">{{ task.priority|default:"medium" }}</span>
            </li>
            {% empty %}
            <li class="task-item"><em>No tasks assigned yet.</em></li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- Right Column: Side Info -->
      <div class="column-right">
        <!-- Wellbeing card -->
       <div class="card wellbeing {% if has_checked_in_today %}completed{% endif %}" 
             id="wellbeingCard">
          <div id="wellbeingContent">
            {% if has_checked_in_today %}
              <div class="checkin-complete">
                <div class="complete-icon">âœ…</div>
                <p class="complete-text">Today's Check In Complete!</p>
              </div>
            {% else %}
              <p>{{ wellbeing_prompt|default:"How are you feeling today?" }}</p>
              <ul class="status-list">
                <li><span class="status good"></span> Feeling Great</li>
                <li><span class="status okay"></span> Doing Okay</li>
                <li><span class="status bad"></span> Feeling Stressed</li>
              </ul>
              <button class="btn-checkin" id="openWellbeingModal">
                Start Check In
              </button>
            {% endif %}
        </div>
      </div>
        
        <!-- Container where modal will be inserted -->
        <div id="wellbeingModalContainer"></div>

        <!-- Team Activity -->
        <div class="card team-activity">
          <h3>Team Activity</h3>
          <ul>
            {% for activity in team_activity %}
            <li>
              <strong>{{ activity.user|default:"Unknown User" }}</strong>
              {{ activity.action|default:"did something" }}
              <em>{{ activity.item|default:"an item" }}</em>
              <span class="time">{{ activity.time|default:"just now" }}</span>
            </li>
            {% empty %}
            <li><em>No recent activity.</em></li>
            {% endfor %}
          </ul>
        </div>

        <!-- Quick Actions -->
        <div class="card quick-actions">
          <h3>Quick Actions</h3>
          <ul>
            {% for action in quick_actions %}
            <li>{{ action.icon|default:"âš¡" }} {{ action.label|default:"Action" }}</li>
            {% endfor %}
          </ul>
        </div>

      </div>
    </section>

  </main>
</div>

<script>
// --- IMMEDIATE CHECK-IN STATUS VERIFICATION ---
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, verifying check-in status...');
    verifyCheckinStatus();
});

// Function to verify check-in status
function verifyCheckinStatus() {
    fetch("{% url 'verify_checkin_status' %}", {
        method: 'GET',
        headers: { 
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log('Check-in status verification:', data);
        if (data.has_checked_in_today) {
            updateWellbeingCardToComplete();
        }
        // If hasn't checked in, the card already shows the check-in option
    })
    .catch(error => {
        console.error('Error verifying check-in status:', error);
    });
}

// --- TASK MODAL ---
document.getElementById('openTaskModal').addEventListener('click', function() {
  fetch("{% url 'tasks' %}")  
    .then(response => response.text())
    .then(html => {
      document.getElementById('taskModalContainer').innerHTML = html;
      const modalElement = document.getElementById('newTaskModal');
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
    });
});

// --- WELLBEING MODAL ---
const wellbeingModalBtn = document.getElementById('openWellbeingModal');

if (wellbeingModalBtn) {
    wellbeingModalBtn.addEventListener('click', function() {
        // Double-check status before opening modal
        fetch("{% url 'verify_checkin_status' %}", {
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.has_checked_in_today) {
                updateWellbeingCardToComplete();
                alert("You've already completed your check-in for today!");
                return;
            }
            
            // Fetch and show modal only if not already checked in
            fetch("{% url 'checkins_modal' %}", {
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                credentials: 'include'
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('wellbeingModalContainer').innerHTML = html;
                const modalElement = document.getElementById('wellbeingModal');
                const modal = new bootstrap.Modal(modalElement);
                modal.show();

                // Initialize modal behavior
                initializeWellbeingModal(modal);
            });
        });
    });
}

// Function to initialize wellbeing modal
function initializeWellbeingModal(modal) {
    const moodInput = document.getElementById("mood_rating");
    const moodValue = document.getElementById("moodValue");
    const dateInput = document.getElementById("date_submitted");
    const form = document.getElementById("wellbeingForm");

    // Update slider value live
    if (moodInput && moodValue) {
        moodValue.textContent = moodInput.value;
        moodInput.addEventListener("input", () => {
            moodValue.textContent = moodInput.value;
        });
    }

    // Auto-fill today's date
    if (dateInput && !dateInput.value) {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        dateInput.value = `${yyyy}-${mm}-${dd}`;
    }

    // Handle form submission with validation
    if (form) {
        form.addEventListener("submit", function(event) {
            event.preventDefault();

            const moodRating = moodInput ? moodInput.value : "";
            const statusSelect = document.getElementById("status");
            const status = statusSelect ? statusSelect.value : "";
            const notesInput = document.getElementById("notes");
            const notes = notesInput ? notesInput.value.trim() : "";

            // Validation: check required fields
            if (!moodRating) {
                alert("Please select a mood rating.");
                return;
            }
            if (!status) {
                alert("Please select your status from the dropdown.");
                return;
            }
            if (!notes) {
                alert("Please enter some notes about how you feel.");
                return;
            }

            const formData = new FormData(form);
            fetch("{% url 'checkins_modal' %}", {
                method: "POST",
                body: formData,
                headers: { 
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": getCookie('csrftoken')
                },
                credentials: "include"
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI to show completed state
                    updateWellbeingCardToComplete();
                    modal.hide();
                    showNotification(data.message, 'success');
                } else {
                    showNotification("Error: " + data.message, 'error');
                }
            })
            .catch(error => {
                console.error("Error:", error);
                showNotification("An error occurred while submitting the check-in.", 'error');
            });
        });
    }
}

// Function to update the wellbeing card to completed state
function updateWellbeingCardToComplete() {
    const wellbeingCard = document.getElementById('wellbeingCard');
    const wellbeingContent = document.getElementById('wellbeingContent');
    
    if (wellbeingCard && wellbeingContent) {
        wellbeingCard.classList.add('completed');
        wellbeingContent.innerHTML = `
            <div class="checkin-complete">
                <div class="complete-icon">âœ…</div>
                <p class="complete-text">Today's Check In Complete!</p>
            </div>
        `;
        
        // Remove any existing modal button
        const existingBtn = document.getElementById('openWellbeingModal');
        if (existingBtn) {
            existingBtn.remove();
        }
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Notification function
function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
    `;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}
</script>

{% endblock %}