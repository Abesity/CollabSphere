{% extends "base_dashboard.html" %}

{% load static %}

{% block title %}Home ‚Äì CollabSphere{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/sidebar.css' %}?v=1.0">
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=1.0">
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/sidebar.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid dashboard-container">

  <!-- Main Content -->
  <main class="dashboard-main">
    
    <!-- Welcome Section -->
    <section class="welcome-text">
      <h1>{{ greeting }}, {{ user_name|default:"User" }}!</h1>
      <p>{{ team_message|default:"Here's what's happening with your team today." }}</p>
    </section>

    <!-- Summary Cards -->
    <section class="summary-cards">
      <div class="card summary card-tasks">
        <div class="card-content">
          <div class="card-text">
            <h3>Active Tasks</h3>
            <p class="number">{{ active_tasks|default:"0" }}</p>
          </div>
          <div class="card-icon">
            <span class="emoji-icon">üìã</span>
          </div>
        </div>
      </div>

      <div class="card summary card-members">
        <div class="card-content">
          <div class="card-text">
            <h3>Team Members</h3>
            <p class="number">{{ team_members_count|default:"0" }}</p>
          </div>
          <div class="card-icon">
            <span class="emoji-icon">üë•</span>
          </div>
        </div>
      </div>

      <div class="card summary card-productivity">
        <div class="card-content">
          <div class="card-text">
            <h3>Productivity</h3>
            <p class="number">{{ productivity|default:"0%" }}</p>
          </div>
          <div class="card-icon">
            <span class="emoji-icon">üöÄ</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Bottom Grid -->
    <section class="bottom-grid">
      
      <!-- Left Column: Tasks -->
      <div class="column-left">
        <div class="card tasks">
          <div class="card-header">
            <h3>My Tasks</h3>
            <button class="btn-new" id="openTaskModal">+ New Task</button>
          </div>
          
          <!-- Task Tabs -->
          <div class="task-tabs">
            <button class="task-tab active" data-tab="all-tasks">All Tasks</button>
            <button class="task-tab" data-tab="created-tasks">Created by Me</button>
            <button class="task-tab" data-tab="assigned-tasks">Assigned to Me</button>
          </div>
          
          <div id="taskModalContainer"></div>
          
          <!-- Task List Header Labels -->
          <div class="task-list-header">
            <span class="header-task">Task</span>
            <span class="header-status">Status</span>
            <span class="header-due-date">Due Date</span>
          </div>
          
          <!-- All Tasks Tab Content -->
          <div id="all-tasks" class="task-tab-content active">
            <ul class="task-list" id="taskList">
              {% if tasks %}
                {% for task in tasks %}
                  <li class="task-item" onclick="openTaskDetail('{{ task.task_id }}')">
                    <div class="task-title">{{ task.title }}</div>
                    <div class="task-details">
                      {% if task.status == 'Pending' %}
                        <span class="status-circle pending" aria-hidden="true"></span>
                      {% elif task.status == 'In Progress' %}
                        <span class="status-circle in-progress" aria-hidden="true"></span>
                      {% elif task.status == 'Completed' %}
                        <span class="status-circle completed" aria-hidden="true"></span>
                      {% else %}
                        <span class="status-circle pending" aria-hidden="true"></span>
                      {% endif %}

                      <div class="task-meta-right">
                        <span class="status">{{ task.status }}</span>
                        <span class="due-date">{{ task.due_date }}</span>
                      </div>
                    </div>
                  </li>
                {% endfor %}
              {% else %}
                <li class="task-item empty">No tasks yet.</li>
              {% endif %}
            </ul>
          </div>
          
          <!-- Created Tasks Tab Content -->
          <div id="created-tasks" class="task-tab-content">
            <ul class="task-list">
              {% if created_tasks_count > 0 %}
                {% for task in tasks %}
                  {% if task.created_by == user.username %}
                    <li class="task-item" onclick="openTaskDetail('{{ task.task_id }}')">
                      <div class="task-title">{{ task.title }}</div>
                      <div class="task-details">
                        {% if task.status == 'Pending' %}
                          <span class="status-circle pending" aria-hidden="true"></span>
                        {% elif task.status == 'In Progress' %}
                          <span class="status-circle in-progress" aria-hidden="true"></span>
                        {% elif task.status == 'Completed' %}
                          <span class="status-circle completed" aria-hidden="true"></span>
                        {% else %}
                          <span class="status-circle pending" aria-hidden="true"></span>
                        {% endif %}

                        <div class="task-meta-right">
                          <span class="status">{{ task.status }}</span>
                          <span class="due-date">{{ task.due_date }}</span>
                        </div>
                      </div>
                    </li>
                  {% endif %}
                {% endfor %}
              {% else %}
                <li class="task-item empty">No tasks created by you.</li>
              {% endif %}
            </ul>
          </div>
          
          <!-- Assigned Tasks Tab Content -->
          <div id="assigned-tasks" class="task-tab-content">
            <ul class="task-list">
              {% if assigned_tasks_count > 0 %}
                {% for task in tasks %}
                  {% if task.assigned_to == user.username or task.assigned_to_username == user.username %}
                    <li class="task-item" onclick="openTaskDetail('{{ task.task_id }}')">
                      <div class="task-title">{{ task.title }}</div>
                      <div class="task-details">
                        {% if task.status == 'Pending' %}
                          <span class="status-circle pending" aria-hidden="true"></span>
                        {% elif task.status == 'In Progress' %}
                          <span class="status-circle in-progress" aria-hidden="true"></span>
                        {% elif task.status == 'Completed' %}
                          <span class="status-circle completed" aria-hidden="true"></span>
                        {% else %}
                          <span class="status-circle pending" aria-hidden="true"></span>
                        {% endif %}

                        <div class="task-meta-right">
                          <span class="status">{{ task.status }}</span>
                          <span class="due-date">{{ task.due_date }}</span>
                        </div>
                      </div>
                    </li>
                  {% endif %}
                {% endfor %}
              {% else %}
                <li class="task-item empty">No tasks assigned to you.</li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>

      <!-- Rest of your right column content remains the same -->
      <div class="column-right">
        <!-- Wellbeing card -->
        <div class="card wellbeing {% if has_checked_in_today %}completed{% endif %}" 
             id="wellbeingCard">
          <div id="wellbeingContent">
            {% if has_checked_in_today %}
              <div class="checkin-complete">
                <div class="complete-icon">üéâ</div>
                <p class="complete-text">Today's Check In Complete!</p>
              </div>
            {% else %}
              <p>{{ wellbeing_prompt|default:"How are you feeling today?" }}</p>
              <ul class="status-list">
                <li><span class="status good"></span> üòä Feeling Great</li>
                <li><span class="status okay"></span> üòê Doing Okay</li>
                <li><span class="status bad"></span> üò∞ Feeling Stressed</li>
              </ul>
              <button class="btn-checkin" id="openWellbeingModal">
                Start Check In
              </button>
            {% endif %}
          </div>
        </div>
        
        <!-- Container where modal will be inserted -->
        <div id="wellbeingModalContainer"></div>

        
    </section>
  </main>
</div>

<script src="{% static 'js/daily_checkin_reminder.js' %}"></script>

<script>
// Tab Switching Functionality
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.task-tab');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            // Remove active class from all tabs and tab contents
            document.querySelectorAll('.task-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.task-tab-content').forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            this.classList.add('active');
            document.getElementById(targetTab).classList.add('active');
        });
    });
});

// Helper function to safely remove existing modals
function removeModalIfExists(modalId) {
    return new Promise(resolve => {
        const modalElement = document.getElementById(modalId);
        if (!modalElement) {
            resolve();
            return;
        }

        if (modalElement.contains(document.activeElement)) {
            document.activeElement.blur();
        }

        const modalInstance = bootstrap.Modal.getInstance(modalElement);

        if (modalInstance && modalElement.classList.contains('show')) {
            modalElement.addEventListener('hidden.bs.modal', () => {
                modalInstance.dispose();
                modalElement.remove();
                resolve();
            }, { once: true });
            modalInstance.hide();
        } else {
            if (modalInstance) {
                modalInstance.dispose();
            }
            modalElement.remove();
            resolve();
        }
    });
}

// Helper to show a Bootstrap modal for messages (info/error)
function showModalMessage(title, message) {
    // Remove existing global modal if present
    const existing = document.getElementById('globalMessageModal');
    if (existing) {
        const inst = bootstrap.Modal.getInstance(existing);
        if (inst) inst.dispose();
        existing.remove();
    }

    const modalHtml = `
    <div class="modal fade" id="globalMessageModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">${title}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body"><p>${message}</p></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>`;

    const tmp = document.createElement('div');
    tmp.innerHTML = modalHtml;
    document.body.appendChild(tmp.firstElementChild);
    const el = document.getElementById('globalMessageModal');
    const m = new bootstrap.Modal(el);
    m.show();
}

// --- TASK MODAL ---
document.getElementById('openTaskModal').addEventListener('click', async function() {
    try {
        const response = await fetch("{% url 'tasks' %}");
        if (!response.ok) {
            throw new Error('Failed to fetch task modal.');
        }

        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        const fetchedModal = doc.getElementById('newTaskModal');
        if (!fetchedModal) {
            throw new Error('Task creation modal markup missing in response.');
        }

        await removeModalIfExists('newTaskModal');

        // Ensure required stylesheets are available
        doc.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
            const href = link.getAttribute('href');
            if (href && !document.querySelector(`link[href="${href}"]`)) {
                const styleTag = document.createElement('link');
                Array.from(link.attributes).forEach(attr => {
                    styleTag.setAttribute(attr.name, attr.value);
                });
                document.head.appendChild(styleTag);
            }
        });

        document.body.appendChild(fetchedModal);
        const modal = new bootstrap.Modal(fetchedModal);
        
        const dateInput = fetchedModal.querySelector("#dateCreated");
        const today = new Date();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const yyyy = today.getFullYear();
        const todayStr = `${yyyy}-${mm}-${dd}`;
        if (dateInput) {
            dateInput.value = todayStr;
        }

        const completionSlider = fetchedModal.querySelector("#completion");
        const completionLabel = fetchedModal.querySelector("#completionValue");

        if (completionSlider && completionLabel) {
            completionLabel.textContent = completionSlider.value;
            completionSlider.addEventListener("input", function() {
                completionLabel.textContent = this.value;
            });
        }

        // --- Task date validation (Start Date / Due Date) ---
        const taskForm = fetchedModal.querySelector('#taskForm');
        const startDateInput = fetchedModal.querySelector('#startDate');
        const dueDateInput = fetchedModal.querySelector('#dueDate');

        // Ensure minimum selectable dates are today
        if (startDateInput) {
            startDateInput.setAttribute('min', todayStr);
        }
        if (dueDateInput) {
            dueDateInput.setAttribute('min', todayStr);
        }

        function validateTaskDates() {
            const creationDate = dateInput ? dateInput.value : todayStr;
            const start = startDateInput ? startDateInput.value : null;
            const due = dueDateInput ? dueDateInput.value : null;

            // Start Date must not be earlier than creation date (today)
            if (start && start < creationDate) {
                if (typeof showError === 'function') {
                    showError("Data didn't get saved because the Start Date can't be before today.");
                } else {
                    alert("Data didn't get saved because the Start Date can't be before today.");
                }
                startDateInput.value = '';
                return false;
            }

            // Due Date must not be earlier than creation date (today)
            if (due && due < creationDate) {
                if (typeof showError === 'function') {
                    showError("Data didn't get saved because the Due Date can't be before today.");
                } else {
                    alert("Data didn't get saved because the Due Date can't be before today.");
                }
                dueDateInput.value = '';
                return false;
            }

            // Due Date must not be before Start Date
            if (start && due && due < start) {
                if (typeof showError === 'function') {
                    showError('Due Date cannot be before the Start Date.');
                } else {
                    alert('Due Date cannot be before the Start Date.');
                }
                return false;
            }

            return true;
        }

        if (startDateInput) {
            startDateInput.addEventListener('change', validateTaskDates);
        }
        if (dueDateInput) {
            dueDateInput.addEventListener('change', validateTaskDates);
        }

        if (taskForm) {
            taskForm.addEventListener('submit', function(e) {
                if (!validateTaskDates()) {
                    e.preventDefault();
                    return false;
                }
            });
        }

        // Execute any scripts inside the fetched modal
        doc.querySelectorAll('script').forEach(script => {
            const newScript = document.createElement('script');
            if (script.src) {
                newScript.src = script.src;
            } else {
                newScript.textContent = script.textContent;
            }
            document.body.appendChild(newScript);
        });

        modal.show();
        } catch (error) {
        console.error("Error loading task modal:", error);
        showModalMessage('Error', 'Could not load task modal. Please try again.');
    }
});// Function to open task detail modal
async function openTaskDetail(taskId) {
  try {
      const response = await fetch(`/tasks/${taskId}/detail/`, {
          headers: { "X-Requested-With": "XMLHttpRequest" },
          credentials: "include"
      });

      if (!response.ok) {
          // Try to extract a helpful message from JSON or text
          let msg = 'Failed to fetch task detail.';
          try {
              const maybeJson = await response.clone().json();
              if (maybeJson && maybeJson.message) msg = maybeJson.message;
          } catch (e) {
              try {
                  const maybeText = await response.clone().text();
                  if (maybeText) msg = 'Server returned unexpected content.';
              } catch (e2) {
                  /* ignore */
              }
          }
          showModalMessage('Error', msg);
          return;
      }

      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      const fetchedModal = doc.getElementById('taskDetailModal');
      if (!fetchedModal) {
          const bodySnippet = doc && doc.body ? doc.body.textContent.trim().slice(0,1000) : '';
          showModalMessage('Error', 'Task detail modal markup missing in response. Server said: ' + (bodySnippet || 'No response body.'));
          return;
      }

      await removeModalIfExists('taskDetailModal');

      doc.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
          const href = link.getAttribute('href');
          if (href && !document.querySelector(`link[href="${href}"]`)) {
              const styleTag = document.createElement('link');
              Array.from(link.attributes).forEach(attr => {
                  styleTag.setAttribute(attr.name, attr.value);
              });
              document.head.appendChild(styleTag);
          }
      });

      document.body.appendChild(fetchedModal);

      doc.querySelectorAll('script').forEach(script => {
          const newScript = document.createElement('script');
          if (script.src) {
              newScript.src = script.src;
          } else {
              newScript.textContent = script.textContent;
          }
          document.body.appendChild(newScript);
      });

      const modal = new bootstrap.Modal(fetchedModal);
      modal.show();

      setTimeout(() => {
          const completionSlider = fetchedModal.querySelector("#completion");
          const completionValue = fetchedModal.querySelector("#completionValue");
          if (completionSlider && completionValue) {
              completionValue.textContent = completionSlider.value;
              completionSlider.addEventListener("input", () => {
                  completionValue.textContent = completionSlider.value;
              });
          }
      }, 100);
  } catch (error) {
      console.error("Error loading task detail:", error);
      showModalMessage('Error', 'Could not load task details. Please try again.');
  }
}

// --- WELLBEING MODAL ---
const wellbeingModalBtn = document.getElementById('openWellbeingModal');

if (wellbeingModalBtn) {
    wellbeingModalBtn.addEventListener('click', function() {

        // Double-check status before opening modal
        fetch("{% url 'verify_checkin_status' %}", {
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.has_checked_in_today) {
                updateWellbeingCardToComplete();
                showModalMessage('Info', "You've already completed your check-in for today!");
                return;
            }
            
            // Fetch and show modal only if not already checked in
            fetch("{% url 'checkins_modal' %}", {
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                credentials: 'include'
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('wellbeingModalContainer').innerHTML = html;
                const modalElement = document.getElementById('wellbeingModal');
                const modal = new bootstrap.Modal(modalElement);
                modal.show();

                // Initialize modal behavior
                initializeWellbeingModal(modal);
            });
        });
    });
}

// Function to initialize wellbeing modal
function initializeWellbeingModal(modal) {
    const moodInput = document.getElementById("mood_rating");
    const moodValue = document.getElementById("moodValue");
    const dateInput = document.getElementById("date_submitted");
    const form = document.getElementById("wellbeingForm");

    // Update slider value live
    if (moodInput && moodValue) {
        moodValue.textContent = moodInput.value;
        moodInput.addEventListener("input", () => {
            moodValue.textContent = moodInput.value;
        });
    }

    // Auto-fill today's date
    if (dateInput && !dateInput.value) {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        dateInput.value = `${yyyy}-${mm}-${dd}`;
    }

    // Handle form submission with validation
    if (form) {
        form.addEventListener("submit", function(event) {
            event.preventDefault();

            const moodRating = moodInput ? moodInput.value : "";
            const statusSelect = document.getElementById("status");
            const status = statusSelect ? statusSelect.value : "";
            const notesInput = document.getElementById("notes");
            const notes = notesInput ? notesInput.value.trim() : "";

            // Validation: check required fields
            if (!moodRating) {
                showModalMessage('Error', 'Please select a mood rating.');
                return;
            }
            if (!status) {
                showModalMessage('Error', 'Please select your status from the dropdown.');
                return;
            }
            if (!notes) {
                showModalMessage('Error', 'Please enter some notes about how you feel.');
                return;
            }

            const formData = new FormData(form);
            fetch("{% url 'checkins_modal' %}", {
                method: "POST",
                body: formData,
                headers: { 
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": getCookie('csrftoken')
                },
                credentials: "include"
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI to show completed state
                    updateWellbeingCardToComplete();
                    modal.hide();
                    showNotification(data.message, 'success');
                } else {
                    showNotification("Error: " + data.message, 'error');
                }
            })
            .catch(error => {
                console.error("Error:", error);
                showNotification("An error occurred while submitting the check-in.", 'error');
            });
        });
    }
}

// Function to update the wellbeing card to completed state
function updateWellbeingCardToComplete() {
    const wellbeingCard = document.getElementById('wellbeingCard');
    const wellbeingContent = document.getElementById('wellbeingContent');
    
    if (wellbeingCard && wellbeingContent) {
        wellbeingCard.classList.add('completed');
        wellbeingContent.innerHTML = `
            <div class="checkin-complete">
                <div class="complete-icon">‚úÖ</div>
                <p class="complete-text">Today's Check In Complete!</p>
            </div>
        `;
        
        // Remove any existing modal button
        const existingBtn = document.getElementById('openWellbeingModal');
        if (existingBtn) {
            existingBtn.remove();
        }
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Notification function
function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
    `;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}
</script>

{% endblock %}