{% extends "base_dashboard.html" %}

{% load static %}

{% block title %}Home â€“ CollabSphere{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/sidebar.css' %}?v=1.0">
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=1.0">
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/sidebar.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid dashboard-container">

  <!-- Main Content -->
  <main class="dashboard-main">
    
    <!-- Welcome Section -->
    <section class="welcome-text">
      <h1>{{ greeting }}, {{ user_name|default:"User" }}!</h1>
      <p>{{ team_message|default:"Here's what's happening with your team today." }}</p>
    </section>

    <!-- Summary Cards -->
    <section class="summary-cards">
      <div class="card summary">
        <div class="card-content">
          <div class="card-text">
            <h3>Active Tasks</h3>
            <p class="number">{{ active_tasks|default:"0" }}</p>
          </div>
          <div class="card-icon">
            <img src="{% static 'images/tasks.png' %}" alt="Tasks Icon">
          </div>
        </div>
      </div>

      <div class="card summary">
        <div class="card-content">
          <div class="card-text">
            <h3>Team Members</h3>
            <p class="number">{{ team_members_count|default:"0" }}</p>
          </div>
          <div class="card-icon">
            <img src="{% static 'images/members.png' %}" alt="Members Icon">
          </div>
        </div>
      </div>

      <div class="card summary">
        <div class="card-content">
          <div class="card-text">
            <h3>Productivity</h3>
            <p class="number">{{ productivity|default:"0%" }}</p>
          </div>
          <div class="card-icon">
            <img src="{% static 'images/productivity.png' %}" alt="Productivity Icon">
          </div>
        </div>
      </div>
    </section>

    <!-- Bottom Grid -->
    <section class="bottom-grid">
      
      <!-- Left Column: Tasks -->
      <div class="column-left">
        <div class="card tasks">
          <div class="card-header">
            <h3>My Tasks</h3>
            <button class="btn-new" id="openTaskModal">+ New Task</button>
          </div>
          
          <!-- Task Tabs -->
          <div class="task-tabs">
            <button class="task-tab active" data-tab="all-tasks">All Tasks</button>
            <button class="task-tab" data-tab="created-tasks">Created by Me</button>
            <button class="task-tab" data-tab="assigned-tasks">Assigned to Me</button>
          </div>
          
          <div id="taskModalContainer"></div>
          
          <!-- Task List Header Labels -->
          <div class="task-list-header">
            <span class="header-task">Task</span>
            <span class="header-status">Status</span>
            <span class="header-due-date">Due Date</span>
          </div>
          
          <!-- All Tasks Tab Content -->
          <div id="all-tasks" class="task-tab-content active">
            <ul class="task-list" id="taskList">
              {% if tasks %}
                {% for task in tasks %}
                  <li class="task-item" onclick="openTaskDetail('{{ task.task_id }}')">
                    <div class="task-title">{{ task.title }}</div>
                    <div class="task-details">
                      {% if task.status == 'Pending' %}
                        <span class="status-circle pending" aria-hidden="true"></span>
                      {% elif task.status == 'In Progress' %}
                        <span class="status-circle in-progress" aria-hidden="true"></span>
                      {% elif task.status == 'Completed' %}
                        <span class="status-circle completed" aria-hidden="true"></span>
                      {% else %}
                        <span class="status-circle pending" aria-hidden="true"></span>
                      {% endif %}

                      <div class="task-meta-right">
                        <span class="status">{{ task.status }}</span>
                        <span class="due-date">{{ task.due_date }}</span>
                      </div>
                    </div>
                  </li>
                {% endfor %}
              {% else %}
                <li class="task-item empty">No tasks yet.</li>
              {% endif %}
            </ul>
          </div>
          
          <!-- Created Tasks Tab Content -->
          <div id="created-tasks" class="task-tab-content">
            <ul class="task-list">
              {% if created_tasks_count > 0 %}
                {% for task in tasks %}
                  {% if task.created_by == user.username %}
                    <li class="task-item" onclick="openTaskDetail('{{ task.task_id }}')">
                      <div class="task-title">{{ task.title }}</div>
                      <div class="task-details">
                        {% if task.status == 'Pending' %}
                          <span class="status-circle pending" aria-hidden="true"></span>
                        {% elif task.status == 'In Progress' %}
                          <span class="status-circle in-progress" aria-hidden="true"></span>
                        {% elif task.status == 'Completed' %}
                          <span class="status-circle completed" aria-hidden="true"></span>
                        {% else %}
                          <span class="status-circle pending" aria-hidden="true"></span>
                        {% endif %}

                        <div class="task-meta-right">
                          <span class="status">{{ task.status }}</span>
                          <span class="due-date">{{ task.due_date }}</span>
                        </div>
                      </div>
                    </li>
                  {% endif %}
                {% endfor %}
              {% else %}
                <li class="task-item empty">No tasks created by you.</li>
              {% endif %}
            </ul>
          </div>
          
          <!-- Assigned Tasks Tab Content -->
          <div id="assigned-tasks" class="task-tab-content">
            <ul class="task-list">
              {% if assigned_tasks_count > 0 %}
                {% for task in tasks %}
                  {% if task.assigned_to == user.username or task.assigned_to_username == user.username %}
                    <li class="task-item" onclick="openTaskDetail('{{ task.task_id }}')">
                      <div class="task-title">{{ task.title }}</div>
                      <div class="task-details">
                        {% if task.status == 'Pending' %}
                          <span class="status-circle pending" aria-hidden="true"></span>
                        {% elif task.status == 'In Progress' %}
                          <span class="status-circle in-progress" aria-hidden="true"></span>
                        {% elif task.status == 'Completed' %}
                          <span class="status-circle completed" aria-hidden="true"></span>
                        {% else %}
                          <span class="status-circle pending" aria-hidden="true"></span>
                        {% endif %}

                        <div class="task-meta-right">
                          <span class="status">{{ task.status }}</span>
                          <span class="due-date">{{ task.due_date }}</span>
                        </div>
                      </div>
                    </li>
                  {% endif %}
                {% endfor %}
              {% else %}
                <li class="task-item empty">No tasks assigned to you.</li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>

      <!-- Right Column: Wellbeing -->
      <div class="column-right">
        <!-- Wellbeing card -->
        <div class="card wellbeing {% if has_checked_in_today %}completed{% endif %}" 
             id="wellbeingCard">
          <div id="wellbeingContent">
            {% if has_checked_in_today %}
              <div class="checkin-complete">
                <div class="complete-icon">âœ…</div>
                <p class="complete-text">Today's Check In Complete!</p>
              </div>
            {% else %}
              <p>{{ wellbeing_prompt|default:"How are you feeling today?" }}</p>
              <ul class="status-list">
                <li><span class="status good"></span> Feeling Great</li>
                <li><span class="status okay"></span> Doing Okay</li>
                <li><span class="status bad"></span> Feeling Stressed</li>
              </ul>
              <button class="btn-checkin" id="openWellbeingModal">
                Start Check In
              </button>
            {% endif %}
          </div>
        </div>
        
        <!-- Container where modal will be inserted -->
        <div id="wellbeingModalContainer"></div>
      </div>
        
    </section>
  </main>
</div>

<script src="{% static 'js/daily_checkin_reminder.js' %}"></script>

<script>
// Tab Switching Functionality
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.task-tab');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            // Remove active class from all tabs and tab contents
            document.querySelectorAll('.task-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.task-tab-content').forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            this.classList.add('active');
            document.getElementById(targetTab).classList.add('active');
        });
    });
});

// Helper function to safely remove existing modals
function removeModalIfExists(modalId) {
    return new Promise(resolve => {
        const modalElement = document.getElementById(modalId);
        if (!modalElement) {
            resolve();
            return;
        }

        if (modalElement.contains(document.activeElement)) {
            document.activeElement.blur();
        }

        const modalInstance = bootstrap.Modal.getInstance(modalElement);

        if (modalInstance && modalElement.classList.contains('show')) {
            modalElement.addEventListener('hidden.bs.modal', () => {
                modalInstance.dispose();
                modalElement.remove();
                resolve();
            }, { once: true });
            modalInstance.hide();
        } else {
            if (modalInstance) {
                modalInstance.dispose();
            }
            modalElement.remove();
            resolve();
        }
    });
}

// --- TASK MODAL ---
document.getElementById('openTaskModal').addEventListener('click', async function() {
    try {
        const response = await fetch("{% url 'tasks' %}");
        if (!response.ok) {
            throw new Error('Failed to fetch task modal.');
        }

        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        const fetchedModal = doc.getElementById('newTaskModal');
        if (!fetchedModal) {
            throw new Error('Task creation modal markup missing in response.');
        }

        await removeModalIfExists('newTaskModal');

        // Ensure required stylesheets are available
        doc.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
            const href = link.getAttribute('href');
            if (href && !document.querySelector(`link[href="${href}"]`)) {
                const styleTag = document.createElement('link');
                Array.from(link.attributes).forEach(attr => {
                    styleTag.setAttribute(attr.name, attr.value);
                });
                document.head.appendChild(styleTag);
            }
        });

        document.body.appendChild(fetchedModal);
        const modal = new bootstrap.Modal(fetchedModal);
        
        const dateInput = fetchedModal.querySelector("#dateCreated");
        const today = new Date();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const yyyy = today.getFullYear();
        const todayStr = `${yyyy}-${mm}-${dd}`;
        if (dateInput) {
            dateInput.value = todayStr;
        }

        const completionSlider = fetchedModal.querySelector("#completion");
        const completionLabel = fetchedModal.querySelector("#completionValue");

        if (completionSlider && completionLabel) {
            completionLabel.textContent = completionSlider.value;
            completionSlider.addEventListener("input", function() {
                completionLabel.textContent = this.value;
            });
        }

        // --- Task date validation (Start Date / Due Date) ---
        const taskForm = fetchedModal.querySelector('#taskForm');
        const startDateInput = fetchedModal.querySelector('#startDate');
        const dueDateInput = fetchedModal.querySelector('#dueDate');

        // Ensure minimum selectable dates are today
        if (startDateInput) {
            startDateInput.setAttribute('min', todayStr);
        }
        if (dueDateInput) {
            dueDateInput.setAttribute('min', todayStr);
        }

        function validateTaskDates() {
            const creationDate = dateInput ? dateInput.value : todayStr;
            const start = startDateInput ? startDateInput.value : null;
            const due = dueDateInput ? dueDateInput.value : null;

            // Start Date must not be earlier than creation date (today)
            if (start && start < creationDate) {
                if (typeof showError === 'function') {
                    showError("Data didn't get saved because the Start Date can't be before today.");
                } else {
                    alert("Data didn't get saved because the Start Date can't be before today.");
                }
                startDateInput.value = '';
                return false;
            }

            // Due Date must not be earlier than creation date (today)
            if (due && due < creationDate) {
                if (typeof showError === 'function') {
                    showError("Data didn't get saved because the Due Date can't be before today.");
                } else {
                    alert("Data didn't get saved because the Due Date can't be before today.");
                }
                dueDateInput.value = '';
                return false;
            }

            // Due Date must not be before Start Date
            if (start && due && due < start) {
                if (typeof showError === 'function') {
                    showError('Due Date cannot be before the Start Date.');
                } else {
                    alert('Due Date cannot be before the Start Date.');
                }
                return false;
            }

            return true;
        }

        if (startDateInput) {
            startDateInput.addEventListener('change', validateTaskDates);
        }
        if (dueDateInput) {
            dueDateInput.addEventListener('change', validateTaskDates);
        }

        if (taskForm) {
            taskForm.addEventListener('submit', function(e) {
                if (!validateTaskDates()) {
                    e.preventDefault();
                    return false;
                }
            });
        }

        // Execute any scripts inside the fetched modal
        doc.querySelectorAll('script').forEach(script => {
            const newScript = document.createElement('script');
            if (script.src) {
                newScript.src = script.src;
            } else {
                newScript.textContent = script.textContent;
            }
            document.body.appendChild(newScript);
        });

        modal.show();
    } catch (error) {
        console.error("Error loading task modal:", error);
        alert("Could not load task modal. Please try again.");
    }
});

// Function to open task detail modal - UPDATED WITH BETTER ERROR HANDLING
async function openTaskDetail(taskId) {
  console.log('ðŸ”µ Opening task detail for ID:', taskId);
  
  try {
      // Construct the URL properly
      const url = `/tasks/${taskId}/detail/`;
      console.log('ðŸ”µ Fetching from URL:', url);
      
      const response = await fetch(url, {
          method: 'GET',
          headers: { 
              "X-Requested-With": "XMLHttpRequest",
              "Accept": "text/html"
          },
          credentials: "include"
      });

      console.log('ðŸ”µ Response status:', response.status);
      console.log('ðŸ”µ Response ok:', response.ok);

      if (!response.ok) {
          const errorText = await response.text();
          console.error('âŒ Server response error:', errorText);
          throw new Error(`Server returned ${response.status}: ${response.statusText}`);
      }

      const html = await response.text();
      console.log('ðŸ”µ Received HTML length:', html.length);
      
      if (!html || html.trim().length === 0) {
          throw new Error('Empty response from server');
      }

      // Remove any existing modal first
      console.log('ðŸ”µ Removing any existing task detail modals...');
      await removeModalIfExists('taskDetailModal');

      // Create a temporary container to hold the HTML
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      
      // Find the modal in the temporary container
      let fetchedModal = tempDiv.querySelector('#taskDetailModal');
      
      if (!fetchedModal) {
          // Try DOMParser as fallback
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          fetchedModal = doc.getElementById('taskDetailModal');
          
          if (!fetchedModal) {
              console.error('âŒ Modal element not found');
              console.log('HTML preview:', html.substring(0, 1000));
              throw new Error('Task detail modal markup missing in response.');
          }
          
          // Clone it to main document
          fetchedModal = fetchedModal.cloneNode(true);
      }

      console.log('ðŸ”µ Modal element found, appending to body...');
      document.body.appendChild(fetchedModal);

      // Add stylesheets from the response
      console.log('ðŸ”µ Adding stylesheets...');
      const tempStyleDiv = document.createElement('div');
      tempStyleDiv.innerHTML = html;
      tempStyleDiv.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
          const href = link.getAttribute('href');
          if (href && !document.querySelector(`link[href="${href}"]`)) {
              const styleTag = document.createElement('link');
              Array.from(link.attributes).forEach(attr => {
                  styleTag.setAttribute(attr.name, attr.value);
              });
              document.head.appendChild(styleTag);
          }
      });

      console.log('ðŸ”µ Extracting and executing scripts...');
      const scriptRegex = /<script[^>]*>([\s\S]*?)<\/script>/gi;
      let match;
      const scripts = [];
      while ((match = scriptRegex.exec(html)) !== null) {
          scripts.push(match[1]);
      }
      
      // Execute scripts in order
      scripts.forEach(scriptContent => {
          if (scriptContent.trim()) {
              const script = document.createElement('script');
              script.textContent = scriptContent;
              document.body.appendChild(script);
          }
      });

      console.log('ðŸ”µ Showing modal...');
      const modalElement = document.getElementById('taskDetailModal');
      if (modalElement) {
          const modal = new bootstrap.Modal(modalElement);
          modal.show();

          // Initialize completion slider
          setTimeout(() => {
              const completionSlider = modalElement.querySelector("#completion");
              const completionValue = modalElement.querySelector("#completionValue");
              if (completionSlider && completionValue) {
                  completionValue.textContent = completionSlider.value;
                  completionSlider.addEventListener("input", () => {
                      completionValue.textContent = completionSlider.value;
                  });
              }
          }, 100);

          console.log('âœ… Task detail modal opened successfully');
      } else {
          throw new Error('Modal element not found after appending to DOM');
      }

  } catch (error) {
      console.error("âŒ Error loading task detail:", error);
      console.error("âŒ Error stack:", error.stack);
      
      let errorMessage = "Could not load task details. ";
      if (error.message.includes('404')) {
          errorMessage += "Task not found.";
      } else if (error.message.includes('403')) {
          errorMessage += "You don't have permission to view this task.";
      } else if (error.message.includes('500')) {
          errorMessage += "Server error. Please try again later.";
      } else {
          errorMessage += "Please try again.";
      }
      
      if (typeof showError === 'function') {
          showError(errorMessage);
      } else {
          alert(errorMessage);
      }
  }
}

// --- WELLBEING MODAL ---
const wellbeingModalBtn = document.getElementById('openWellbeingModal');

if (wellbeingModalBtn) {
    wellbeingModalBtn.addEventListener('click', function() {

        // Double-check status before opening modal
        fetch("{% url 'verify_checkin_status' %}", {
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.has_checked_in_today) {
                updateWellbeingCardToComplete();
                alert("You've already completed your check-in for today!");
                return;
            }
            
            // Fetch and show modal only if not already checked in
            fetch("{% url 'checkins_modal' %}", {
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                credentials: 'include'
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('wellbeingModalContainer').innerHTML = html;
                const modalElement = document.getElementById('wellbeingModal');
                const modal = new bootstrap.Modal(modalElement);
                modal.show();

                // Initialize modal behavior
                initializeWellbeingModal(modal);
            });
        });
    });
}

// Function to initialize wellbeing modal
function initializeWellbeingModal(modal) {
    const moodInput = document.getElementById("mood_rating");
    const moodValue = document.getElementById("moodValue");
    const dateInput = document.getElementById("date_submitted");
    const form = document.getElementById("wellbeingForm");

    // Update slider value live
    if (moodInput && moodValue) {
        moodValue.textContent = moodInput.value;
        moodInput.addEventListener("input", () => {
            moodValue.textContent = moodInput.value;
        });
    }

    // Auto-fill today's date
    if (dateInput && !dateInput.value) {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        dateInput.value = `${yyyy}-${mm}-${dd}`;
    }

    // Handle form submission with validation
    if (form) {
        form.addEventListener("submit", function(event) {
            event.preventDefault();

            const moodRating = moodInput ? moodInput.value : "";
            const statusSelect = document.getElementById("status");
            const status = statusSelect ? statusSelect.value : "";
            const notesInput = document.getElementById("notes");
            const notes = notesInput ? notesInput.value.trim() : "";

            // Validation: check required fields
            if (!moodRating) {
                alert("Please select a mood rating.");
                return;
            }
            if (!status) {
                alert("Please select your status from the dropdown.");
                return;
            }
            if (!notes) {
                alert("Please enter some notes about how you feel.");
                return;
            }

            const formData = new FormData(form);
            fetch("{% url 'checkins_modal' %}", {
                method: "POST",
                body: formData,
                headers: { 
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": getCookie('csrftoken')
                },
                credentials: "include"
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI to show completed state
                    updateWellbeingCardToComplete();
                    modal.hide();
                    showNotification(data.message, 'success');
                } else {
                    showNotification("Error: " + data.message, 'error');
                }
            })
            .catch(error => {
                console.error("Error:", error);
                showNotification("An error occurred while submitting the check-in.", 'error');
            });
        });
    }
}

// Function to update the wellbeing card to completed state
function updateWellbeingCardToComplete() {
    const wellbeingCard = document.getElementById('wellbeingCard');
    const wellbeingContent = document.getElementById('wellbeingContent');
    
    if (wellbeingCard && wellbeingContent) {
        wellbeingCard.classList.add('completed');
        wellbeingContent.innerHTML = `
            <div class="checkin-complete">
                <div class="complete-icon">âœ…</div>
                <p class="complete-text">Today's Check In Complete!</p>
            </div>
        `;
        
        // Remove any existing modal button
        const existingBtn = document.getElementById('openWellbeingModal');
        if (existingBtn) {
            existingBtn.remove();
        }
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Notification function
function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
    `;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}
</script>

{% endblock %}