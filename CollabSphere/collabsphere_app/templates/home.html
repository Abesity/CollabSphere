{% extends "base_dashboard.html" %}
{% load static %}

{% block title %}Home â€“ CollabSphere{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/sidebar.css' %}?v=1.0">
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=1.0">
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/sidebar.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid dashboard-container">

  <!-- Sidebar -->
  <aside id="sidebar-nav" class="sidebar">
    <div class="list-group list-group-flush">
      <a href="#" class="list-group-item sidebar-link active">Profile</a>
      <a href="#" class="list-group-item sidebar-link">Security</a>
      <a href="#" class="list-group-item sidebar-link">Notifications</a>
      <a href="#" class="list-group-item sidebar-link">Team Members</a>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="dashboard-main">
    
    <!-- Welcome Section -->
    <section class="welcome-text">
      <h1>Good {{ greeting }}, {{ user_name|default:"User" }}!</h1>
      <p>{{ team_message|default:"Hereâ€™s whatâ€™s happening with your team today." }}</p>
    </section>

    <!-- Summary Cards -->
    <section class="summary-cards">
      <div class="card summary">
        <div class="card-content">
          <div class="card-text">
            <h3>Active Tasks</h3>
            <p class="number">{{ active_tasks|default:"0" }}</p>
          </div>
          <div class="card-icon">
            <img src="{% static 'images/tasks.png' %}" alt="Tasks Icon">
          </div>
        </div>
      </div>

      <div class="card summary">
        <div class="card-content">
          <div class="card-text">
            <h3>Team Members</h3>
            <p class="number">{{ team_members_count|default:"0" }}</p>
          </div>
          <div class="card-icon">
            <img src="{% static 'images/members.png' %}" alt="Members Icon">
          </div>
        </div>
      </div>

      <div class="card summary">
        <div class="card-content">
          <div class="card-text">
            <h3>Productivity</h3>
            <p class="number">{{ productivity|default:"0%" }}</p>
          </div>
          <div class="card-icon">
            <img src="{% static 'images/productivity.png' %}" alt="Productivity Icon">
          </div>
        </div>
      </div>
    </section>

    <!-- Bottom Grid -->
    <section class="bottom-grid">
      
      <!-- Left Column: Tasks -->
      <div class="column-left">
        <div class="card tasks">
          <div class="card-header">
            <h3>My Tasks</h3>
            <button class="btn-new" id="openTaskModal">+ New Task</button>
          </div>
          <div id="taskModalContainer"></div>  
          <ul class="task-list">
            {% for task in tasks %}
            <li class="task-item">
              <span>{{ task.icon|default:"ðŸ“„" }} {{ task.title|default:"Untitled Task" }}</span>
              <span class="task-label {{ task.priority|default:"medium" }}">{{ task.priority|default:"medium" }}</span>
            </li>
            {% empty %}
            <li class="task-item"><em>No tasks assigned yet.</em></li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- Right Column: Side Info -->
      <div class="column-right">

        <!-- Well-being -->
        <div class="card wellbeing" id="openWellbeingModal" style="cursor:pointer;">
          <h3>Daily Well-being Check</h3>
          <p>{{ wellbeing_prompt|default:"How are you feeling today?" }}</p>
          <ul class="status-list">
            <li><span class="status good"></span> Feeling Great</li>
            <li><span class="status okay"></span> Doing Okay</li>
            <li><span class="status bad"></span> Feeling Stressed</li>
          </ul>
        </div>
        <div id="wellbeingModalContainer"></div>

        <!-- Team Activity -->
        <div class="card team-activity">
          <h3>Team Activity</h3>
          <ul>
            {% for activity in team_activity %}
            <li>
              <strong>{{ activity.user|default:"Unknown User" }}</strong>
              {{ activity.action|default:"did something" }}
              <em>{{ activity.item|default:"an item" }}</em>
              <span class="time">{{ activity.time|default:"just now" }}</span>
            </li>
            {% empty %}
            <li><em>No recent activity.</em></li>
            {% endfor %}
          </ul>
        </div>

        <!-- Quick Actions -->
        <div class="card quick-actions">
          <h3>Quick Actions</h3>
          <ul>
            {% for action in quick_actions %}
            <li>{{ action.icon|default:"âš¡" }} {{ action.label|default:"Action" }}</li>
            {% empty %}
            <li><em>No quick actions available.</em></li>
            {% endfor %}
          </ul>
        </div>

      </div>
    </section>

  </main>
</div>

<script>
// --- TASK MODAL ---
document.getElementById('openTaskModal').addEventListener('click', function() {
  fetch("{% url 'tasks' %}")  
    .then(response => response.text())
    .then(html => {
      document.getElementById('taskModalContainer').innerHTML = html;
      const modalElement = document.getElementById('newTaskModal');
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
    });
});


// --- WELLBEING MODAL ---
document.getElementById('openWellbeingModal').addEventListener('click', function() {
  fetch("{% url 'checkins_modal' %}", {
    method: 'GET',
    credentials: 'include'
  })
  .then(response => {
    if (response.redirected) {
      window.location.href = response.url;
      return;
    }
    return response.text();
  })
  .then(html => {
    if (!html) return;
    const container = document.getElementById('wellbeingModalContainer');
    container.innerHTML = html;

    const modalElement = container.querySelector('#wellbeingModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();

    // --- Handle form submission via AJAX ---
    const form = modalElement.querySelector('form');
    form.addEventListener('submit', function(event) {
      event.preventDefault();
      const formData = new FormData(form);

      fetch("{% url 'checkins_modal' %}", {
        method: 'POST',
        body: formData,
        credentials: 'include',
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          modal.hide();
        } else {
          alert("Error: " + data.message);
        }
      })
      .catch(err => console.error(err));
    });
  })
  .catch(error => console.error("Error loading wellbeing modal:", error));
});
</script>

{% endblock %}
