{% extends "base_dashboard.html" %}
{% load static humanize %}
{% load math_filters %}

{% block title %}Teams – CollabSphere{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/teams.css' %}?v=1.2">
<style>
  /* Alert and Confirm Modal Styles */
  .alert-modal {
    min-width: 300px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  }

  .alert-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #e5e7eb;
  }

  .alert-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
  }

  .modal-close-btn {
    background: none;
    border: none;
    font-size: 28px;
    color: #6b7280;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  .modal-close-btn:hover {
    background: #f3f4f6;
    color: #1f2937;
  }

  .alert-body {
    padding: 20px 24px;
    max-height: 300px;
    overflow-y: auto;
  }

  .alert-body p {
    margin: 0;
    color: #4b5563;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .alert-footer {
    padding: 16px 24px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }

  .btn-primary {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .btn-primary:hover {
    background: #2563eb;
  }

  .btn-primary:active {
    transform: scale(0.98);
  }

  .btn-secondary {
    background: #e5e7eb;
    color: #1f2937;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .btn-secondary:hover {
    background: #d1d5db;
  }

  .btn-secondary:active {
    transform: scale(0.98);
  }
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/sidebar.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid dashboard-container">
  <main class="dashboard-main">
      <!-- Header Section -->
    <section class="welcome-text">
      <h1>Your Teams</h1>
      <p>Browse and manage your teams across CollabSphere.</p>
    </section>

    <!-- Search Bar -->
    <section class="search-section">
      <form method="get" class="search-row" aria-label="Search teams">
        <input
          id="searchInput"
          name="q"
          value="{{ request.GET.q|default:'' }}"
          class="search-input"
          type="search"
          placeholder="Search by team name, description, or owner..."
          autocomplete="off"
        />
        <button type="submit" class="search-btn">Search</button>
        <button type="button" id="clearBtn" class="search-btn btn-clear">Clear</button>
      </form>
    </section>

    <!-- Teams Grid -->
  <section class="teams-grid-section">
    <div id="teamsGrid" class="grid">
      <!-- Add New Team Card -->
      <button id="addTeamBtn" class="add-team-btn" title="Create New Team">
        +
      </button>
      
      {% if teams %}
        {% for team in teams %}
          {% include "team_card.html" with team=team %}
        {% endfor %}
      {% endif %}
    </div>
  </section>
  </main>
</div>

<div id="createTeamModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" id="createTeamModalContent">
    <!-- The create_team.html content will be injected here -->
  </div>
</div>

<div id="editTeamModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" id="editTeamModalContent">
    <!-- The edit_team.html content will be injected here -->
  </div>
</div>

<!-- Alert Modal -->
<div id="alertModal" class="modal-overlay" style="display:none;">
  <div class="modal-content alert-modal" style="max-width: 400px;">
    <div class="alert-header">
      <h3 id="alertTitle">Alert</h3>
      <button class="modal-close-btn" onclick="closeAlertModal()">×</button>
    </div>
    <div class="alert-body">
      <p id="alertMessage"></p>
    </div>
    <div class="alert-footer">
      <button class="btn-primary" onclick="closeAlertModal()">OK</button>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div id="confirmModal" class="modal-overlay" style="display:none;">
  <div class="modal-content alert-modal" style="max-width: 400px;">
    <div class="alert-header">
      <h3 id="confirmTitle">Confirm</h3>
      <button class="modal-close-btn" onclick="closeConfirmModal()">×</button>
    </div>
    <div class="alert-body">
      <p id="confirmMessage"></p>
    </div>
    <div class="alert-footer">
      <button class="btn-secondary" onclick="closeConfirmModal()">Cancel</button>
      <button class="btn-primary" id="confirmBtn" onclick="handleConfirmAction()">Confirm</button>
    </div>
  </div>
</div>

<script>
// ===== MODAL UTILITY FUNCTIONS =====
let confirmCallback = null;

function showAlertModal(title, message) {
  document.getElementById('alertTitle').textContent = title;
  document.getElementById('alertMessage').textContent = message;
  document.getElementById('alertModal').style.display = 'flex';
}

function closeAlertModal() {
  document.getElementById('alertModal').style.display = 'none';
}

function showConfirmModal(title, message, onConfirm) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMessage').textContent = message;
  confirmCallback = onConfirm;
  document.getElementById('confirmModal').style.display = 'flex';
}

function closeConfirmModal() {
  document.getElementById('confirmModal').style.display = 'none';
  confirmCallback = null;
}

function handleConfirmAction() {
  if (confirmCallback) {
    confirmCallback();
  }
  closeConfirmModal();
}

// Close modals when clicking outside
document.addEventListener('click', function(e) {
  const alertModal = document.getElementById('alertModal');
  const confirmModal = document.getElementById('confirmModal');
  
  if (e.target === alertModal) closeAlertModal();
  if (e.target === confirmModal) closeConfirmModal();
});

// ===== SEARCH FUNCTIONALITY =====
(function() {
  const input = document.getElementById('searchInput');
  const clearBtn = document.getElementById('clearBtn');
  const grid = document.getElementById('teamsGrid');
  if (!grid) return;
  const cards = Array.from(grid.querySelectorAll('.team-card'));

  function filterCards(q) {
    const qLower = q.trim().toLowerCase();
    let anyVisible = false;
    cards.forEach(card => {
      const visible = !qLower ||
        card.dataset.name.includes(qLower) ||
        card.dataset.desc.includes(qLower) ||
        card.dataset.owner.includes(qLower);
      card.style.display = visible ? '' : 'none';
      anyVisible = anyVisible || visible;
    });

    let no = grid.querySelector('.no-results');
    if (!anyVisible && !no) {
      no = document.createElement('div');
      no.className = 'no-results';
      no.innerHTML = '<p>No teams match your search.</p>';
      grid.appendChild(no);
    } else if (anyVisible && no) {
      no.remove();
    }
  }

  input.addEventListener('input', e => filterCards(e.target.value));
  clearBtn.addEventListener('click', () => {
    input.value = '';
    filterCards('');
  });

  document.addEventListener('DOMContentLoaded', () => filterCards(input.value));
})();

// Switch team functionality 
function setupSwitchTeamButtons() {
    const switchButtons = document.querySelectorAll('.switch-team-btn');
    
    switchButtons.forEach(btn => {
        // Remove any existing event listeners by cloning
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
    });
    
    // Re-select the buttons after cloning
    const freshSwitchButtons = document.querySelectorAll('.switch-team-btn');
    
    freshSwitchButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            const teamId = this.dataset.teamId;
            const teamName = this.dataset.teamName;
            const btn = this;
            
            // Confirmation dialog
            showConfirmModal(
              'Switch Team',
              `Are you sure you want to switch to "${teamName}" as your active team?\n\nYou'll see content and tasks for this team across CollabSphere.`,
              function() {
                // Show loading state
                const originalText = btn.textContent;
                const originalHTML = btn.innerHTML;
                btn.textContent = 'Switching...';
                btn.disabled = true;
                
                fetch(`/teams/switch/${teamId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Success message with team name
                        showSuccessMessage(`Successfully switched to "${teamName}"!`);
                        
                        // Update UI to reflect the change
                        updateActiveTeamUI(teamId);
                        
                        // Force a hard reload to ensure fresh data
                        setTimeout(() => {
                            window.location.reload(true);
                        }, 1500);
                    } else {
                        // Restore button state
                        btn.textContent = originalText;
                        btn.innerHTML = originalHTML;
                        btn.disabled = false;
                        
                        // Show error message
                        showAlertModal('Error', 'Error switching team: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    
                    // Restore button state
                    btn.textContent = originalText;
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    
                    showAlertModal('Error', 'Error switching team. Please try again.');
                });
              }
            );
        });
    });
}

// Function to update UI when team is switched
function updateActiveTeamUI(activeTeamId) {
    // Remove active class from all teams
    document.querySelectorAll('.team-card').forEach(card => {
        card.classList.remove('active-team');
    });
    
    // Add active class to the new active team
    const activeCard = document.querySelector(`.team-card[data-team-id="${activeTeamId}"]`);
    if (activeCard) {
        activeCard.classList.add('active-team');
    }
    
    // Update buttons - switch buttons become active team buttons
    document.querySelectorAll('.switch-team-btn').forEach(btn => {
        btn.textContent = 'Switch to Team';
        btn.disabled = false;
        btn.classList.remove('active-team-btn');
    });
    
    document.querySelectorAll('.active-team-btn').forEach(btn => {
        btn.disabled = true;
    });
}

// Call this function when the page loads
document.addEventListener('DOMContentLoaded', function() {
    setupSwitchTeamButtons();
});

document.addEventListener('DOMContentLoaded', function() {
  const addBtn = document.getElementById('addTeamBtn');
  const modal = document.getElementById("createTeamModal");
  const modalContent = document.getElementById("createTeamModalContent");
  const editModal = document.getElementById("editTeamModal");
  const editModalContent = document.getElementById("editTeamModalContent");
  const editButtons = document.querySelectorAll('.edit-team-btn');
  const viewButtons = document.querySelectorAll('.view-team-btn');
  const leaveButtons = document.querySelectorAll('.leave-team-btn');

  // ===== Open Create Modal =====
  addBtn.addEventListener("click", () => {
    fetch("{% url 'create_team' %}")
      .then(response => response.text())
      .then(html => {
        modalContent.innerHTML = html;
        modal.style.display = "flex";
        document.body.style.overflow = "hidden";

        // Load users without teams
        loadUsersWithoutTeams();
        
        // Wire up close buttons
        const closeBtn = modalContent.querySelector("#closeModalBtn");
        const cancelBtn = modalContent.querySelector("#cancelModalBtn");
        const iconInput = modalContent.querySelector("#id_icon_url");
        const iconPreview = modalContent.querySelector("#iconPreview");

        const closeModal = () => {
          modal.style.display = "none";
          document.body.style.overflow = "auto";
          selectedMembers = [];
        };

        [closeBtn, cancelBtn].forEach(btn => btn?.addEventListener("click", closeModal));
        modal.addEventListener("click", e => {
          if (e.target === modal) closeModal();
        });

        // Image preview
        iconInput?.addEventListener("change", e => {
          const file = e.target.files[0];
          if (file) iconPreview.src = URL.createObjectURL(file);
        });

        // Form submission
        const form = modalContent.querySelector('#createTeamForm');
        if (form) {
          form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');
            
            submitButton.disabled = true;
            submitButton.textContent = 'Creating...';
            
            fetch(form.action, {
              method: 'POST',
              body: formData,
              headers: {
                'X-CSRFToken': '{{ csrf_token }}'
              }
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                closeModal();
                setTimeout(() => {
                  window.location.reload(true);
                }, 100);
              } else {
                if (data.form_errors) {
                  let errorMessage = 'Please fix the following errors:\n';
                  for (const field in data.form_errors) {
                    errorMessage += `- ${data.form_errors[field][0].message}\n`;
                  }
                  showAlertModal('Form Errors', errorMessage);
                } else {
                  showAlertModal('Error', 'Error creating team: ' + data.error);
                }
                submitButton.disabled = false;
                submitButton.textContent = 'Create Team';
              }
            })
            .catch(error => {
              console.error('Error:', error);
              showAlertModal('Error', 'Error creating team. Please try again.');
              submitButton.disabled = false;
              submitButton.textContent = 'Create Team';
            });
          });
        }
      });
  });

  // ===== Edit Team (Owner only) =====
  editButtons.forEach(btn => {
    btn.addEventListener('click', e => {
      const teamId = e.target.dataset.teamId;
      fetch(`/teams/edit/${teamId}/`)
        .then(response => response.text())
        .then(html => {
          editModalContent.innerHTML = html;
          editModal.style.display = "flex";
          document.body.style.overflow = "hidden";

          setupEditTeamModal(editModalContent);

          // Wire up close buttons for edit modal
          const closeBtn = editModalContent.querySelector("#closeEditModalBtn");
          const cancelBtn = editModalContent.querySelector("#cancelEditModalBtn");

          const closeEditModal = () => {
            editModal.style.display = "none";
            document.body.style.overflow = "auto";
          };

          [closeBtn, cancelBtn].forEach(btn => btn?.addEventListener("click", closeEditModal));
          editModal.addEventListener("click", e => {
            if (e.target === editModal) closeEditModal();
          });

          // Handle edit form submission
        const editForm = editModalContent.querySelector('#editTeamForm');
        if (editForm) {
            editForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(editForm);
                const submitButton = editForm.querySelector('button[type="submit"]');
                
                submitButton.disabled = true;
                submitButton.textContent = 'Updating...';
                
                fetch(editForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message and force complete page refresh
                        showSuccessMessage('Team updated successfully!');
                        
                        // Close modal first
                        closeEditModal();
                        
                        // Force a complete refresh of the page to ensure UI is in sync
                        setTimeout(() => {
                            window.location.reload(true); // true forces reload from server, not cache
                        }, 1500);
                    } else {
                        showAlertModal('Error', 'Error updating team: ' + data.error);
                        submitButton.disabled = false;
                        submitButton.textContent = 'Update Team';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlertModal('Error', 'Error updating team. Please try again.');
                    submitButton.disabled = false;
                    submitButton.textContent = 'Update Team';
                });
            });
        }

        })
        .catch(error => {
          console.error('Error loading edit form:', error);
          showAlertModal('Error', 'Error loading team details.');
        });
    });
  });

// ===== View Team (Non-owners) =====
viewButtons.forEach(btn => {
  btn.addEventListener('click', e => {
    const teamId = e.target.dataset.teamId;
    fetch(`/teams/view/${teamId}/`)  // ← CORRECT: This calls view
      .then(response => response.text())
      .then(html => {
        editModalContent.innerHTML = html;
        editModal.style.display = "flex";
        document.body.style.overflow = "hidden";

        // Wire up close buttons for view modal
        const closeBtn = editModalContent.querySelector("#closeViewModalBtn");
        const closeViewBtn = editModalContent.querySelector("#closeViewBtn");
        const leaveBtn = editModalContent.querySelector("#leaveTeamBtn");

        const closeViewModal = () => {
          editModal.style.display = "none";
          document.body.style.overflow = "auto";
        };

        [closeBtn, closeViewBtn].forEach(btn => btn?.addEventListener("click", closeViewModal));
        editModal.addEventListener("click", e => {
          if (e.target === editModal) closeViewModal();
        });

        // Handle leave team button
        if (leaveBtn) {
          leaveBtn.addEventListener('click', function() {
            showConfirmModal(
              'Leave Team',
              'Are you sure you want to leave this team?',
              function() {
                fetch(`/teams/leave/${teamId}/`, {
                  method: 'POST',
                  headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                  }
                })
                .then(response => response.json())
                .then(data => {
                  if (data.success) {
                    showAlertModal('Success', 'You have left the team successfully!');
                    setTimeout(() => window.location.reload(), 1500);
                  } else {
                    showAlertModal('Error', 'Error leaving team: ' + data.error);
                  }
                })
                .catch(error => {
                  console.error('Error:', error);
                  showAlertModal('Error', 'Error leaving team. Please try again.');
                });
              }
            );
          });
        }
      })
      .catch(error => {
        console.error('Error loading view form:', error);
        showAlertModal('Error', 'Error loading team details.');
      });
  });
});

  // ===== Leave Team =====
  leaveButtons.forEach(btn => {
    btn.addEventListener('click', e => {
      const teamId = e.target.dataset.teamId;
      const teamName = e.target.closest('.team-card').querySelector('.team-name').textContent;
      
      showConfirmModal(
        'Leave Team',
        `Are you sure you want to leave the team "${teamName}"?`,
        function() {
          fetch(`/teams/leave/${teamId}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}',
              'Content-Type': 'application/json'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showAlertModal('Success', 'You have left the team successfully!');
              setTimeout(() => window.location.reload(), 1500);
            } else {
              showAlertModal('Error', 'Error leaving team: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showAlertModal('Error', 'Error leaving team. Please try again.');
          });
        }
      );
    });
  });
});


  // Function to show success message
  function showSuccessMessage(message) {
      // Create success message element
      const successMsg = document.createElement('div');
      successMsg.className = 'success-message';
      successMsg.innerHTML = `
          <div class="success-content">
              <span class="success-icon">✓</span>
              <span class="success-text">${message}</span>
          </div>
      `;
      
      // Add styles
      successMsg.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #10b981;
          color: white;
          padding: 16px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 10000;
          animation: slideInRight 0.3s ease-out;
      `;
      
      // Add keyframes for animation
      const style = document.createElement('style');
      style.textContent = `
          @keyframes slideInRight {
              from {
                  transform: translateX(100%);
                  opacity: 0;
              }
              to {
                  transform: translateX(0);
                  opacity: 1;
              }
          }
          .success-content {
              display: flex;
              align-items: center;
              gap: 8px;
          }
          .success-icon {
              font-weight: bold;
              font-size: 18px;
          }
          .success-text {
              font-weight: 500;
          }
      `;
      document.head.appendChild(style);
      
      // Add to page
      document.body.appendChild(successMsg);
      
      // Remove after 3 seconds
      setTimeout(() => {
          successMsg.remove();
          style.remove();
      }, 3000);
  }
// ===== Setup View Team Modal (Read-only) =====
function setupViewTeamModal(editModalContent) {
    const form = editModalContent.querySelector('#editTeamForm');
    const deleteBtn = editModalContent.querySelector('#deleteTeamBtn');
    
    // Disable all form inputs for view mode
    if (form) {
        const inputs = form.querySelectorAll('input, textarea, button, select');
        inputs.forEach(input => {
            if (input.type !== 'hidden') {
                input.disabled = true;
                input.style.opacity = '0.7';
                input.style.cursor = 'not-allowed';
            }
        });
        
        // Hide delete button in view mode
        if (deleteBtn) {
            deleteBtn.style.display = 'none';
        }
        
        // Change submit button text
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.textContent = 'Close';
            submitBtn.type = 'button';
            submitBtn.addEventListener('click', function() {
                document.getElementById('editTeamModal').style.display = 'none';
                document.body.style.overflow = 'auto';
            });
        }
    }
}

// ===== MEMBER MANAGEMENT FUNCTIONS =====
let selectedMembers = [];

function setupMembersSearch() {
  const searchInput = document.getElementById('membersSearch');
  const membersContainer = document.getElementById('membersContainer');
  
  if (searchInput && membersContainer) {
    searchInput.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const userOptions = membersContainer.querySelectorAll('.user-option');
      
      userOptions.forEach(option => {
        const username = option.querySelector('.username').textContent.toLowerCase();
        const email = option.querySelector('.email').textContent.toLowerCase();
        const isSelected = selectedMembers.find(member => member.id === parseInt(option.dataset.userId));
        
        const visible = !isSelected && (username.includes(searchTerm) || email.includes(searchTerm));
        option.style.display = visible ? 'flex' : 'none';
      });
    });
  }
}
function loadUsersWithoutTeams() {
  const membersContainer = document.getElementById("membersContainer");
  const loadingDiv = document.getElementById("membersLoading");
  
  if (!membersContainer) return;
  
  fetch("{% url 'get_users_without_teams' %}")
    .then(response => response.json())
    .then(data => {
      if (data.success && data.users.length > 0) {
        membersContainer.innerHTML = data.users.map(user => 
          `<div class="user-option" data-user-id="${user.user_ID}" data-username="${user.username}" data-email="${user.email}">
            <img src="${user.profile_picture || '{% static "images/default-avatar.png" %}'}" 
                 alt="${user.username}" 
                 class="user-avatar">
            <div class="user-info">
              <div class="username">${user.username}</div>
              <div class="email">${user.email}</div>
            </div>
            <button type="button" class="add-user-btn" onclick="addMemberToTeam(${user.user_ID}, '${user.username.replace(/'/g, "\\'")}')">+</button>
          </div>`
        ).join('');
        loadingDiv.style.display = 'none';
        membersContainer.style.display = 'block';
        
        selectedMembers.forEach(member => {
          removeUserFromSuggestions(member.id);
        });
        
        setupMembersSearch();
      } else {
        loadingDiv.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No available users without teams.</p>';
        membersContainer.style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Error loading users:', error);
      loadingDiv.innerHTML = '<p style="color: #dc2626; text-align: center;">Error loading users.</p>';
    });
}

function addMemberToTeam(userId, username) {
  if (!selectedMembers.find(member => member.id === userId)) {
    selectedMembers.push({ id: userId, username: username });
    updateSelectedMembersDisplay();
    removeUserFromSuggestions(userId);
  }
}

function removeMemberFromTeam(userId) {
  selectedMembers = selectedMembers.filter(member => member.id !== userId);
  updateSelectedMembersDisplay();
  addUserBackToSuggestions(userId);
}

function removeUserFromSuggestions(userId) {
  const userOption = document.querySelector(`.user-option[data-user-id="${userId}"]`);
  if (userOption) {
    userOption.style.display = 'none';
  }
}

function addUserBackToSuggestions(userId) {
  const userOption = document.querySelector(`.user-option[data-user-id="${userId}"]`);
  if (userOption) {
    userOption.style.display = 'flex';
  }
}

function updateSelectedMembersDisplay() {
  const selectedMembersContainer = document.getElementById("selectedMembersContainer");
  const selectedMembersInput = document.getElementById("selectedMembersInput");
  
  if (!selectedMembersContainer) return;
  
  if (selectedMembersInput) {
    selectedMembersInput.value = selectedMembers.map(member => member.id).join(',');
  }
  
  if (selectedMembers.length === 0) {
    selectedMembersContainer.innerHTML = '<div class="no-selected-members">No members selected</div>';
    return;
  }
  
  selectedMembersContainer.innerHTML = selectedMembers.map(member => 
    `<div class="selected-member-tag">
      <span>${member.username}</span>
      <button type="button" onclick="removeMemberFromTeam(${member.id})" class="remove-member-btn">×</button>
    </div>`
  ).join('');
}

// ===== Edit Team Modal Setup =====
// ===== Edit Team Modal Setup =====
function setupEditTeamModal(editModalContent) {
    const form = editModalContent.querySelector('#editTeamForm');
    const iconInput = editModalContent.querySelector('#id_icon_url');
    const iconPreview = editModalContent.querySelector('#iconPreview');
    const deleteBtn = editModalContent.querySelector('#deleteTeamBtn');
    const removeIconCheckbox = editModalContent.querySelector('#removeIcon');

    // Edit team specific variables
    let selectedNewMembers = [];
    let membersToRemove = [];

    // Image preview
    if (iconInput && iconPreview) {
        iconInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                iconPreview.src = URL.createObjectURL(file);
            }
        });
    }

    // Remove icon checkbox handler
    if (removeIconCheckbox) {
        removeIconCheckbox.addEventListener('change', function(e) {
            if (e.target.checked) {
                iconPreview.src = "{% static 'images/default-team-icon.png' %}";
            } else {
                // Get the original icon URL from a data attribute or use default
                const originalIcon = iconPreview.getAttribute('data-original-src') || "{% static 'images/default-team-icon.png' %}";
                iconPreview.src = originalIcon;
            }
        });
    }

    // Event delegation for remove current member buttons
    const currentMembersContainer = editModalContent.querySelector('#currentMembersContainer');
    if (currentMembersContainer) {
        currentMembersContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-member-btn')) {
                const userId = parseInt(e.target.getAttribute('data-user-id'));
                const username = e.target.getAttribute('data-username');
                const memberTag = e.target.closest('.current-member-tag');
                
                showConfirmModal(
                  'Remove Member',
                  `Remove ${username} from the team?`,
                  function() {
                    membersToRemove.push(userId);
                    updateMembersToRemoveInput();
                    
                    // Remove from current members display
                    memberTag.remove();
                    
                    // Check if current members container is empty
                    const currentMembers = currentMembersContainer.querySelectorAll('.current-member-tag');
                    if (currentMembers.length === 0) {
                        currentMembersContainer.innerHTML = '<div class="no-current-members" style="color: var(--text-muted); text-align: center;">No members in team</div>';
                    }
                  }
                );
            }
        });
    }

 // ===== Delete Team =====
if (deleteBtn) {
    deleteBtn.addEventListener('click', function() {
        const deleteBtn = this;
        showConfirmModal(
          'Delete Team',
          'Are you sure you want to delete this team? This action cannot be undone.',
          function() {
            const teamId = form.action.split('/').filter(part => part).pop();
            
            // Show loading state
            const originalText = deleteBtn.textContent;
            deleteBtn.textContent = 'Deleting...';
            deleteBtn.disabled = true;
            
            fetch(`/teams/delete/${teamId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Delete response:', data);
                
                if (data.success === true) {
                    // Show success message
                    showSuccessMessage('Team deleted successfully!');
                    
                    // Close the modal first - use the correct modal reference
                    const editModal = document.getElementById('editTeamModal');
                    if (editModal) {
                        editModal.style.display = "none";
                    }
                    document.body.style.overflow = "auto";
                    
                    // Force a complete page reload after a short delay
                    setTimeout(() => {
                        window.location.reload(true);
                    }, 1500);
                } else {
                    // Restore button state
                    deleteBtn.textContent = originalText;
                    deleteBtn.disabled = false;
                    
                    // Show error message
                    showAlertModal('Error', 'Error deleting team: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Restore button state
                deleteBtn.textContent = originalText;
                deleteBtn.disabled = false;
                
                showAlertModal('Error', 'Error deleting team. Please try again.');
            });
          }
        );
    });
}   

    // Load available users for adding
    loadAvailableUsersForEdit();

    function loadAvailableUsersForEdit() {
    const membersContainer = editModalContent.querySelector("#membersContainer");
    const loadingDiv = editModalContent.querySelector("#membersLoading");
    
    if (!membersContainer) return;
    
    // Get team ID from the form action
    const teamId = form.action.split('/').filter(part => part).pop();
    
    fetch(`{% url 'get_users_without_teams' %}?team_id=${teamId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.users.length > 0) {
                membersContainer.innerHTML = data.users.map(user => 
                    `<div class="user-option" data-user-id="${user.user_ID}" data-username="${user.username}" data-email="${user.email}">
                        <img src="${user.profile_picture || '{% static "images/default-avatar.png" %}'}" 
                             alt="${user.username}" 
                             class="user-avatar">
                        <div class="user-info">
                            <div class="username">${user.username}</div>
                            <div class="email">${user.email}</div>
                        </div>
                        <button type="button" class="add-user-btn" data-user-id="${user.user_ID}" data-username="${user.username}">+</button>
                    </div>`
                ).join('');
                loadingDiv.style.display = 'none';
                membersContainer.style.display = 'block';
                
                // Add event listeners to all add buttons
                membersContainer.querySelectorAll('.add-user-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const userId = parseInt(this.getAttribute('data-user-id'));
                        const username = this.getAttribute('data-username');
                        addNewMemberToTeam(userId, username);
                    });
                });
                
                // Hide already selected members
                selectedNewMembers.forEach(member => {
                    removeUserFromSuggestions(member.id);
                });
                
                setupEditMembersSearch();
            } else {
                loadingDiv.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No available users to add.</p>';
                membersContainer.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading users:', error);
            loadingDiv.innerHTML = '<p style="color: #dc2626; text-align: center;">Error loading users.</p>';
        });
}

    function setupEditMembersSearch() {
        const searchInput = editModalContent.querySelector('#membersSearch');
        const membersContainer = editModalContent.querySelector('#membersContainer');
        
        if (searchInput && membersContainer) {
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const userOptions = membersContainer.querySelectorAll('.user-option');
                
                userOptions.forEach(option => {
                    const username = option.querySelector('.username').textContent.toLowerCase();
                    const email = option.querySelector('.email').textContent.toLowerCase();
                    const isSelected = selectedNewMembers.find(member => member.id === parseInt(option.dataset.userId));
                    
                    const visible = !isSelected && (username.includes(searchTerm) || email.includes(searchTerm));
                    option.style.display = visible ? 'flex' : 'none';
                });
            });
        }
    }

    function addNewMemberToTeam(userId, username) {
        if (!selectedNewMembers.find(member => member.id === userId)) {
            selectedNewMembers.push({ id: userId, username: username });
            updateSelectedMembersDisplay();
            removeUserFromSuggestions(userId);
        }
    }

    function removeNewMemberFromTeam(userId) {
        selectedNewMembers = selectedNewMembers.filter(member => member.id !== userId);
        updateSelectedMembersDisplay();
        addUserBackToSuggestions(userId);
    }

    function updateSelectedMembersDisplay() {
        const selectedMembersContainer = editModalContent.querySelector("#selectedMembersContainer");
        const selectedMembersInput = editModalContent.querySelector("#selectedMembersInput");
        
        if (!selectedMembersContainer) return;
        
        // Update hidden input with selected member IDs
        if (selectedMembersInput) {
            // FIX: Parse comma-separated string instead of JSON
            const currentMemberIdsStr = selectedMembersInput.value || '';
            const currentMemberIds = currentMemberIdsStr 
                ? currentMemberIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id))
                : [];
            
            const allMemberIds = [
                ...currentMemberIds.filter(id => !membersToRemove.includes(id)),
                ...selectedNewMembers.map(member => member.id)
            ];
            selectedMembersInput.value = allMemberIds.join(',');
        }
        
        if (selectedNewMembers.length === 0) {
            selectedMembersContainer.innerHTML = '<div class="no-selected-members" style="color: var(--text-muted); text-align: center;">No new members selected</div>';
            return;
        }
        
        selectedMembersContainer.innerHTML = selectedNewMembers.map(member => 
            `<div class="selected-member-tag">
                <span>${member.username}</span>
                <button type="button" class="remove-new-member-btn" data-user-id="${member.id}">×</button>
            </div>`
        ).join('');
        
        // Add event listeners to remove buttons
        selectedMembersContainer.querySelectorAll('.remove-new-member-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = parseInt(this.getAttribute('data-user-id'));
                removeNewMemberFromTeam(userId);
            });
        });
    }

    function updateMembersToRemoveInput() {
        const membersToRemoveInput = editModalContent.querySelector("#membersToRemoveInput");
        if (membersToRemoveInput) {
            membersToRemoveInput.value = membersToRemove.join(',');
            console.log('Updated membersToRemoveInput:', membersToRemoveInput.value, 'Array:', membersToRemove);
        } else {
            console.warn('membersToRemoveInput not found in DOM');
        }
        updateSelectedMembersDisplay();
    }

    function removeUserFromSuggestions(userId) {
        const userOption = editModalContent.querySelector(`.user-option[data-user-id="${userId}"]`);
        if (userOption) {
            userOption.style.display = 'none';
        }
    }

    function addUserBackToSuggestions(userId) {
        const userOption = editModalContent.querySelector(`.user-option[data-user-id="${userId}"]`);
        if (userOption) {
            userOption.style.display = 'flex';
        }
    }

    // Form submission
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');
            
            // Debug: Log all form data before sending
            console.log('Form submission - membersToRemove array:', membersToRemove);
            const membersToRemoveInput = editModalContent.querySelector("#membersToRemoveInput");
            if (membersToRemoveInput) {
                console.log('membersToRemoveInput value:', membersToRemoveInput.value);
                console.log('membersToRemoveInput from FormData:', formData.get('members_to_remove'));
            }
            
            submitButton.disabled = true;
            submitButton.textContent = 'Updating...';
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlertModal('Success', 'Team updated successfully!');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showAlertModal('Error', 'Error updating team: ' + data.error);
                    submitButton.disabled = false;
                    submitButton.textContent = 'Update Team';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlertModal('Error', 'Error updating team. Please try again.');
                submitButton.disabled = false;
                submitButton.textContent = 'Update Team';
            });
        });
    }
}
</script>

{% endblock %}