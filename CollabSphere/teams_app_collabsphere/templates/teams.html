{% extends "base_dashboard.html" %}
{% load static humanize %}
{% load math_filters %}

{% block title %}Teams â€“ CollabSphere{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/teams.css' %}?v=1.1">
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/sidebar.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid dashboard-container">
  <main class="dashboard-main">

    <!-- Header Section -->
    <section class="welcome-text">
      <h1>Your Teams</h1>
      <p>Browse and manage your teams across CollabSphere.</p>
    </section>

    <!-- Search Bar -->
    <section class="search-section">
      <form method="get" class="search-row" aria-label="Search teams">
        <input
          id="searchInput"
          name="q"
          value="{{ request.GET.q|default:'' }}"
          class="search-input"
          type="search"
          placeholder="Search by team name, description, or owner..."
          autocomplete="off"
        />
        <button type="submit" class="search-btn">Search</button>
        <button type="button" id="clearBtn" class="search-btn btn-clear">Clear</button>
      </form>
    </section>

    <!-- Teams Grid -->
    <section class="teams-grid-section">
      <div class="teams-header">
        <button id="addTeamBtn" class="add-team-btn" title="Create New Team">+</button>
      </div>

      {% if teams %}
        <div id="teamsGrid" class="grid">
          {% for team in teams %}
            {% include "team_card.html" with team=team %}
          {% endfor %}
        </div>
      {% else %}
        <div class="card no-results">
          <p>No teams found.</p>
        </div>
      {% endif %}
    </section>
  </main>
</div>

<div id="createTeamModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" id="createTeamModalContent">
    <!-- The create_team.html content will be injected here -->
  </div>
</div>

<div id="editTeamModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" id="editTeamModalContent">
    <!-- The edit_team.html content will be injected here -->
  </div>
</div>

<script>
(function() {
  const input = document.getElementById('searchInput');
  const clearBtn = document.getElementById('clearBtn');
  const grid = document.getElementById('teamsGrid');
  if (!grid) return;
  const cards = Array.from(grid.querySelectorAll('.team-card'));

  function filterCards(q) {
    const qLower = q.trim().toLowerCase();
    let anyVisible = false;
    cards.forEach(card => {
      const visible = !qLower ||
        card.dataset.name.includes(qLower) ||
        card.dataset.desc.includes(qLower) ||
        card.dataset.owner.includes(qLower);
      card.style.display = visible ? '' : 'none';
      anyVisible = anyVisible || visible;
    });

    let no = grid.querySelector('.no-results');
    if (!anyVisible && !no) {
      no = document.createElement('div');
      no.className = 'no-results';
      no.innerHTML = '<p>No teams match your search.</p>';
      grid.appendChild(no);
    } else if (anyVisible && no) {
      no.remove();
    }
  }

  input.addEventListener('input', e => filterCards(e.target.value));
  clearBtn.addEventListener('click', () => {
    input.value = '';
    filterCards('');
  });

  document.addEventListener('DOMContentLoaded', () => filterCards(input.value));
})();

document.addEventListener('DOMContentLoaded', function() {
  const addBtn = document.getElementById('addTeamBtn');
  const modal = document.getElementById("createTeamModal");
  const modalContent = document.getElementById("createTeamModalContent");
  const editModal = document.getElementById("editTeamModal");
  const editModalContent = document.getElementById("editTeamModalContent");
  const editButtons = document.querySelectorAll('.edit-team-btn');

  // ===== Open Create Modal =====
  addBtn.addEventListener("click", () => {
    fetch("{% url 'create_team' %}")
      .then(response => response.text())
      .then(html => {
        modalContent.innerHTML = html;
        modal.style.display = "flex";
        document.body.style.overflow = "hidden";

        // Load users without teams
        loadUsersWithoutTeams();
        
        // Wire up close buttons
        const closeBtn = modalContent.querySelector("#closeModalBtn");
        const cancelBtn = modalContent.querySelector("#cancelModalBtn");
        const iconInput = modalContent.querySelector("#id_icon_url");
        const iconPreview = modalContent.querySelector("#iconPreview");

        const closeModal = () => {
          modal.style.display = "none";
          document.body.style.overflow = "auto";
          selectedMembers = [];
        };

        [closeBtn, cancelBtn].forEach(btn => btn?.addEventListener("click", closeModal));
        modal.addEventListener("click", e => {
          if (e.target === modal) closeModal();
        });

        // Image preview
        iconInput?.addEventListener("change", e => {
          const file = e.target.files[0];
          if (file) iconPreview.src = URL.createObjectURL(file);
        });

        // Form submission
        const form = modalContent.querySelector('#createTeamForm');
        if (form) {
          form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');
            
            submitButton.disabled = true;
            submitButton.textContent = 'Creating...';
            
            fetch(form.action, {
              method: 'POST',
              body: formData,
              headers: {
                'X-CSRFToken': '{{ csrf_token }}'
              }
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                closeModal();
                setTimeout(() => {
                  window.location.reload(true);
                }, 100);
              } else {
                if (data.form_errors) {
                  let errorMessage = 'Please fix the following errors:\n';
                  for (const field in data.form_errors) {
                    errorMessage += `- ${data.form_errors[field][0].message}\n`;
                  }
                  alert(errorMessage);
                } else {
                  alert('Error creating team: ' + data.error);
                }
                submitButton.disabled = false;
                submitButton.textContent = 'Create Team';
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('Error creating team. Please try again.');
              submitButton.disabled = false;
              submitButton.textContent = 'Create Team';
            });
          });
        }
      });
  });

  // ===== Edit Team =====
  editButtons.forEach(btn => {
    btn.addEventListener('click', e => {
      const teamId = e.target.dataset.teamId;
      fetch(`/teams/edit/${teamId}/`)
        .then(response => response.text())
        .then(html => {
          editModalContent.innerHTML = html;
          editModal.style.display = "flex";
          document.body.style.overflow = "hidden";

          setupEditTeamModal(editModalContent);

          // Wire up close buttons for edit modal
          const closeBtn = editModalContent.querySelector("#closeEditModalBtn");
          const cancelBtn = editModalContent.querySelector("#cancelEditModalBtn");

          const closeEditModal = () => {
            editModal.style.display = "none";
            document.body.style.overflow = "auto";
          };

          [closeBtn, cancelBtn].forEach(btn => btn?.addEventListener("click", closeEditModal));
          editModal.addEventListener("click", e => {
            if (e.target === editModal) closeEditModal();
          });

          // Handle edit form submission
          const editForm = editModalContent.querySelector('#editTeamForm');
          if (editForm) {
            editForm.addEventListener('submit', function(e) {
              e.preventDefault();
              
              const formData = new FormData(editForm);
              const submitButton = editForm.querySelector('button[type="submit"]');
              
              submitButton.disabled = true;
              submitButton.textContent = 'Updating...';
              
              fetch(editForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                  'X-CSRFToken': '{{ csrf_token }}'
                }
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  closeEditModal();
                  setTimeout(() => {
                    window.location.reload(true);
                  }, 100);
                } else {
                  alert('Error updating team: ' + data.error);
                  submitButton.disabled = false;
                  submitButton.textContent = 'Update Team';
                }
              })
              .catch(error => {
                console.error('Error:', error);
                alert('Error updating team. Please try again.');
                submitButton.disabled = false;
                submitButton.textContent = 'Update Team';
              });
            });
          }
        })
        .catch(error => {
          console.error('Error loading edit form:', error);
          alert('Error loading team editor.');
        });
    });
  });
});

// ===== MEMBER MANAGEMENT FUNCTIONS =====
let selectedMembers = [];

// ... (rest of the member management functions remain the same)
function setupMembersSearch() {
  const searchInput = document.getElementById('membersSearch');
  const membersContainer = document.getElementById('membersContainer');
  
  if (searchInput && membersContainer) {
    searchInput.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const userOptions = membersContainer.querySelectorAll('.user-option');
      
      userOptions.forEach(option => {
        const username = option.querySelector('.username').textContent.toLowerCase();
        const email = option.querySelector('.email').textContent.toLowerCase();
        const isSelected = selectedMembers.find(member => member.id === parseInt(option.dataset.userId));
        
        const visible = !isSelected && (username.includes(searchTerm) || email.includes(searchTerm));
        option.style.display = visible ? 'flex' : 'none';
      });
    });
  }
}
function loadUsersWithoutTeams() {
  const membersContainer = document.getElementById("membersContainer");
  const loadingDiv = document.getElementById("membersLoading");
  
  if (!membersContainer) return;
  
  fetch("{% url 'get_users_without_teams' %}")
    .then(response => response.json())
    .then(data => {
      if (data.success && data.users.length > 0) {
        membersContainer.innerHTML = data.users.map(user => 
          `<div class="user-option" data-user-id="${user.user_ID}" data-username="${user.username}" data-email="${user.email}">
            <img src="${user.profile_picture || '{% static "images/default-avatar.png" %}'}" 
                 alt="${user.username}" 
                 class="user-avatar">
            <div class="user-info">
              <div class="username">${user.username}</div>
              <div class="email">${user.email}</div>
            </div>
            <button type="button" class="add-user-btn" onclick="addMemberToTeam(${user.user_ID}, '${user.username.replace(/'/g, "\\'")}')">+</button>
          </div>`
        ).join('');
        loadingDiv.style.display = 'none';
        membersContainer.style.display = 'block';
        
        selectedMembers.forEach(member => {
          removeUserFromSuggestions(member.id);
        });
        
        setupMembersSearch();
      } else {
        loadingDiv.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No available users without teams.</p>';
        membersContainer.style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Error loading users:', error);
      loadingDiv.innerHTML = '<p style="color: #dc2626; text-align: center;">Error loading users.</p>';
    });
}

function addMemberToTeam(userId, username) {
  if (!selectedMembers.find(member => member.id === userId)) {
    selectedMembers.push({ id: userId, username: username });
    updateSelectedMembersDisplay();
    removeUserFromSuggestions(userId);
  }
}

function removeMemberFromTeam(userId) {
  selectedMembers = selectedMembers.filter(member => member.id !== userId);
  updateSelectedMembersDisplay();
  addUserBackToSuggestions(userId);
}

function removeUserFromSuggestions(userId) {
  const userOption = document.querySelector(`.user-option[data-user-id="${userId}"]`);
  if (userOption) {
    userOption.style.display = 'none';
  }
}

function addUserBackToSuggestions(userId) {
  const userOption = document.querySelector(`.user-option[data-user-id="${userId}"]`);
  if (userOption) {
    userOption.style.display = 'flex';
  }
}

function updateSelectedMembersDisplay() {
  const selectedMembersContainer = document.getElementById("selectedMembersContainer");
  const selectedMembersInput = document.getElementById("selectedMembersInput");
  
  if (!selectedMembersContainer) return;
  
  if (selectedMembersInput) {
    selectedMembersInput.value = selectedMembers.map(member => member.id).join(',');
  }
  
  if (selectedMembers.length === 0) {
    selectedMembersContainer.innerHTML = '<div class="no-selected-members">No members selected</div>';
    return;
  }
  
  selectedMembersContainer.innerHTML = selectedMembers.map(member => 
    `<div class="selected-member-tag">
      <span>${member.username}</span>
      <button type="button" onclick="removeMemberFromTeam(${member.id})" class="remove-member-btn">Ã—</button>
    </div>`
  ).join('');
}

// ===== Edit Team Modal Setup =====
// ===== Edit Team Modal Setup =====
function setupEditTeamModal(editModalContent) {
    const form = editModalContent.querySelector('#editTeamForm');
    const iconInput = editModalContent.querySelector('#id_icon_url');
    const iconPreview = editModalContent.querySelector('#iconPreview');
    const deleteBtn = editModalContent.querySelector('#deleteTeamBtn');
    const removeIconCheckbox = editModalContent.querySelector('#removeIcon');

    // Edit team specific variables
    let selectedNewMembers = [];
    let membersToRemove = [];

    // Image preview
    if (iconInput && iconPreview) {
        iconInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                iconPreview.src = URL.createObjectURL(file);
            }
        });
    }

    // Remove icon checkbox handler
    if (removeIconCheckbox) {
        removeIconCheckbox.addEventListener('change', function(e) {
            if (e.target.checked) {
                iconPreview.src = "{% static 'images/default-team-icon.png' %}";
            } else {
                // Get the original icon URL from a data attribute or use default
                const originalIcon = iconPreview.getAttribute('data-original-src') || "{% static 'images/default-team-icon.png' %}";
                iconPreview.src = originalIcon;
            }
        });
    }

    // Event delegation for remove current member buttons
    const currentMembersContainer = editModalContent.querySelector('#currentMembersContainer');
    if (currentMembersContainer) {
        currentMembersContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-member-btn')) {
                const userId = parseInt(e.target.getAttribute('data-user-id'));
                const username = e.target.getAttribute('data-username');
                if (confirm(`Remove ${username} from the team?`)) {
                    membersToRemove.push(userId);
                    updateMembersToRemoveInput();
                    
                    // Remove from current members display
                    e.target.closest('.current-member-tag').remove();
                    
                    // Check if current members container is empty
                    const currentMembers = currentMembersContainer.querySelectorAll('.current-member-tag');
                    if (currentMembers.length === 0) {
                        currentMembersContainer.innerHTML = '<div class="no-current-members" style="color: var(--text-muted); text-align: center;">No members in team</div>';
                    }
                }
            }
        });
    }

    // Delete team button
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this team? This action cannot be undone.')) {
                const teamId = form.action.split('/').filter(part => part).pop();
                fetch(`/teams/delete/${teamId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Team deleted successfully!');
                        window.location.reload();
                    } else {
                        alert('Error deleting team: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting team. Please try again.');
                });
            }
        });
    }

    // Load available users for adding
    loadAvailableUsersForEdit();

    function loadAvailableUsersForEdit() {
        const membersContainer = editModalContent.querySelector("#membersContainer");
        const loadingDiv = editModalContent.querySelector("#membersLoading");
        
        if (!membersContainer) return;
        
        fetch("{% url 'get_users_without_teams' %}")
            .then(response => response.json())
            .then(data => {
                if (data.success && data.users.length > 0) {
                    // FIX: Parse comma-separated string instead of JSON
                    const selectedMembersInput = editModalContent.querySelector('#selectedMembersInput');
                    const currentMemberIds = selectedMembersInput && selectedMembersInput.value 
                        ? selectedMembersInput.value.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id))
                        : [];
                    
                    membersContainer.innerHTML = data.users
                        .filter(user => !currentMemberIds.includes(user.user_ID))
                        .map(user => {
                            const profilePic = user.profile_picture || "{% static 'images/default-avatar.png' %}";
                            return `
                            <div class="user-option" data-user-id="${user.user_ID}">
                                <img src="${profilePic}" 
                                     alt="${user.username}" 
                                     class="user-avatar">
                                <div class="user-info">
                                    <div class="username">${user.username}</div>
                                    <div class="email">${user.email}</div>
                                </div>
                                <button type="button" class="add-user-btn" data-user-id="${user.user_ID}" data-username="${user.username}">+</button>
                            </div>`;
                        }).join('');
                    
                    loadingDiv.style.display = 'none';
                    membersContainer.style.display = 'block';
                    
                    // Add event listeners to add buttons
                    membersContainer.querySelectorAll('.add-user-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const userId = parseInt(this.getAttribute('data-user-id'));
                            const username = this.getAttribute('data-username');
                            addNewMemberToTeam(userId, username);
                        });
                    });
                    
                    setupEditMembersSearch();
                } else {
                    loadingDiv.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No available users to add.</p>';
                    membersContainer.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error loading users:', error);
                loadingDiv.innerHTML = '<p style="color: #dc2626; text-align: center;">Error loading users.</p>';
            });
    }

    function setupEditMembersSearch() {
        const searchInput = editModalContent.querySelector('#membersSearch');
        const membersContainer = editModalContent.querySelector('#membersContainer');
        
        if (searchInput && membersContainer) {
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const userOptions = membersContainer.querySelectorAll('.user-option');
                
                userOptions.forEach(option => {
                    const username = option.querySelector('.username').textContent.toLowerCase();
                    const email = option.querySelector('.email').textContent.toLowerCase();
                    const isSelected = selectedNewMembers.find(member => member.id === parseInt(option.dataset.userId));
                    
                    const visible = !isSelected && (username.includes(searchTerm) || email.includes(searchTerm));
                    option.style.display = visible ? 'flex' : 'none';
                });
            });
        }
    }

    function addNewMemberToTeam(userId, username) {
        if (!selectedNewMembers.find(member => member.id === userId)) {
            selectedNewMembers.push({ id: userId, username: username });
            updateSelectedMembersDisplay();
            removeUserFromSuggestions(userId);
        }
    }

    function removeNewMemberFromTeam(userId) {
        selectedNewMembers = selectedNewMembers.filter(member => member.id !== userId);
        updateSelectedMembersDisplay();
        addUserBackToSuggestions(userId);
    }

    function updateSelectedMembersDisplay() {
        const selectedMembersContainer = editModalContent.querySelector("#selectedMembersContainer");
        const selectedMembersInput = editModalContent.querySelector("#selectedMembersInput");
        
        if (!selectedMembersContainer) return;
        
        // Update hidden input with selected member IDs
        if (selectedMembersInput) {
            // FIX: Parse comma-separated string instead of JSON
            const currentMemberIdsStr = selectedMembersInput.value || '';
            const currentMemberIds = currentMemberIdsStr 
                ? currentMemberIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id))
                : [];
            
            const allMemberIds = [
                ...currentMemberIds.filter(id => !membersToRemove.includes(id)),
                ...selectedNewMembers.map(member => member.id)
            ];
            selectedMembersInput.value = allMemberIds.join(',');
        }
        
        if (selectedNewMembers.length === 0) {
            selectedMembersContainer.innerHTML = '<div class="no-selected-members" style="color: var(--text-muted); text-align: center;">No new members selected</div>';
            return;
        }
        
        selectedMembersContainer.innerHTML = selectedNewMembers.map(member => 
            `<div class="selected-member-tag">
                <span>${member.username}</span>
                <button type="button" class="remove-new-member-btn" data-user-id="${member.id}">Ã—</button>
            </div>`
        ).join('');
        
        // Add event listeners to remove buttons
        selectedMembersContainer.querySelectorAll('.remove-new-member-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = parseInt(this.getAttribute('data-user-id'));
                removeNewMemberFromTeam(userId);
            });
        });
    }

    function updateMembersToRemoveInput() {
        const membersToRemoveInput = editModalContent.querySelector("#membersToRemoveInput");
        if (membersToRemoveInput) {
            membersToRemoveInput.value = membersToRemove.join(',');
        }
        updateSelectedMembersDisplay();
    }

    function removeUserFromSuggestions(userId) {
        const userOption = editModalContent.querySelector(`.user-option[data-user-id="${userId}"]`);
        if (userOption) {
            userOption.style.display = 'none';
        }
    }

    function addUserBackToSuggestions(userId) {
        const userOption = editModalContent.querySelector(`.user-option[data-user-id="${userId}"]`);
        if (userOption) {
            userOption.style.display = 'flex';
        }
    }

    // Form submission
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');
            
            submitButton.disabled = true;
            submitButton.textContent = 'Updating...';
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Team updated successfully!');
                    window.location.reload();
                } else {
                    alert('Error updating team: ' + data.error);
                    submitButton.disabled = false;
                    submitButton.textContent = 'Update Team';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating team. Please try again.');
                submitButton.disabled = false;
                submitButton.textContent = 'Update Team';
            });
        });
    }
}
</script>

{% endblock %}