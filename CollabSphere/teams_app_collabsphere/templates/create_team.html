<!-- create_team.html -->
{% load static %}

<div>
  <button class="modal-close" id="closeModalBtn">&times;</button>
  <h2 style="text-align:center;">Create a New Team</h2>

  <form id="createTeamForm" method="post" enctype="multipart/form-data" action="{% url 'create_team' %}">
    {% csrf_token %}
    
    <!-- Use form fields instead of manual inputs -->
    {{ form.selected_members }}

    <!-- Team Icon first -->
    <div class="icon-upload-section" style="text-align:center; margin-bottom: 1.25rem;">
      <div class="icon-preview" id="iconPreviewContainer" style="margin-bottom:0.75rem;">
        <img
          id="iconPreview"
          src="{% static 'images/default-team-icon.png' %}"
          alt="Team icon preview"
          style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #e5e7eb;"
        >
      </div>
      <label for="id_icon_url" style="display:block; font-weight:600; margin-bottom:0.4rem;">Team Icon (optional)</label>
      {{ form.icon_url }}
    </div>

    <div class="form-group">
      <label for="id_team_name">Team Name <span style="color:#dc2626">*</span></label>
      {{ form.team_name }}
      {% if form.team_name.errors %}
        <div class="error-message">{{ form.team_name.errors }}</div>
      {% endif %}
    </div>

    <div class="form-group">
      <label for="id_description">Description</label>
      {{ form.description }}
    </div>

    <!-- Add Members Section - NEW TAG STYLE -->
    <div class="form-group">
      <label for="membersSearch">Add Team Members</label>
      
      <!-- Selected Members Display -->
      <div id="selectedMembersContainer" class="selected-members-container" style="min-height: 50px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; margin-bottom: 10px; background: #f9fafb;">
        <div class="no-selected-members" style="color: var(--text-muted); text-align: center;">No members selected</div>
      </div>

      <!-- Search and User List -->
      <div class="members-search-section">
        <input 
          type="text" 
          id="membersSearch" 
          class="search-input" 
          placeholder="Search for users to add..."
          autocomplete="off"
          style="margin-bottom: 10px;"
        >
        
        <div id="membersLoading" style="text-align: center; padding: 20px; color: var(--text-muted);">
          Loading available users...
        </div>
        
        <div id="membersContainer" class="members-container" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
          <!-- Users will be populated here by JavaScript -->
        </div>
      </div>

    </div>

    <div class="modal-buttons" style="text-align:right;">
      <button type="submit" class="btn-primary">Create Team</button>
      <button type="button" class="btn-secondary" id="cancelModalBtn">Cancel</button>
    </div>
  </form>
</div>

<script>
// Handle form submission for the create team form
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('createTeamForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');
            
            // Disable submit button to prevent multiple submissions
            submitButton.disabled = true;
            submitButton.textContent = 'Creating...';
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close the modal
                    const modal = document.getElementById("createTeamModal");
                    if (modal) {
                        modal.style.display = "none";
                        document.body.style.overflow = "auto";
                    }
                    
                    // Show success message and reload the page to see the new team
                    alert('Team created successfully!');
                    window.location.reload(); // This will refresh the teams page
                } else {
                    // Handle form validation errors
                    if (data.form_errors) {
                        const errors = JSON.parse(data.form_errors);
                        let errorMessage = 'Please fix the following errors:\n';
                        for (const field in errors) {
                            errorMessage += `- ${errors[field][0].message}\n`;
                        }
                        alert(errorMessage);
                    } else {
                        alert('Error creating team: ' + data.error);
                    }
                    submitButton.disabled = false;
                    submitButton.textContent = 'Create Team';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating team. Please try again.');
                submitButton.disabled = false;
                submitButton.textContent = 'Create Team';
            });
        });
    }

    // Image preview for dynamically loaded form
    const iconInput = document.getElementById('id_icon_url');
    const iconPreview = document.getElementById('iconPreview');
    
    if (iconInput && iconPreview) {
        iconInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                iconPreview.src = URL.createObjectURL(file);
            }
        });
    }
});
</script>