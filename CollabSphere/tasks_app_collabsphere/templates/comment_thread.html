<!-- 
  NOTE: This file is NOT needed for the standalone task_detail.html version.
  The standalone version includes all comment threading inline.
  
  If you want to use recursive includes, use this template with the recursive version.
-->

{% load static %}

<div class="comment-item mb-3 p-3 border rounded {% if depth > 0 %}reply-section{% endif %}" data-comment-id="{{ comment.comment_id }}">
  <div class="d-flex justify-content-between align-items-start mb-2">
    <strong class="comment-author">{{ comment.username }}</strong>
    <div>
      <small class="text-muted me-2">{{ comment.created_at|date:"M j, Y g:i A" }}</small>
      {% if comment.username == request.user.username %}
        <form class="delete-comment-form d-inline" method="POST" action="{% url 'delete_comment' comment_id=comment.comment_id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-link text-danger p-0 delete-btn">Delete</button>
        </form>
      {% endif %}
    </div>
  </div>
  
  <p class="mb-0 comment-content">{{ comment.content }}</p>
  
  <div class="comment-actions">
    <button type="button" class="btn btn-sm btn-outline-secondary btn-reply" data-comment-id="{{ comment.comment_id }}">
      Reply
    </button>
  </div>
  
  <!-- Reply Form -->
  <div id="reply-form-{{ comment.comment_id }}" class="reply-form" style="display: none;">
    <form class="reply-comment-form" method="POST" action="{% url 'add_comment' task_id=task.task_id %}">
      {% csrf_token %}
      <input type="hidden" name="parent_id" value="{{ comment.comment_id }}">
      <div class="mb-2">
        <textarea name="content" class="form-control form-control-sm" rows="2" placeholder="Write a reply..." required></textarea>
      </div>
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary btn-sm">Post Reply</button>
        <button type="button" class="btn btn-secondary btn-sm cancel-reply-btn">Cancel</button>
      </div>
    </form>
  </div>
  
  <!-- Render nested replies recursively -->
  {% if comment.replies %}
    <div class="replies mt-3">
      {% for reply in comment.replies %}
        {% include 'comment_thread.html' with comment=reply depth=depth|add:1 %}
      {% endfor %}
    </div>
  {% endif %}
</div>