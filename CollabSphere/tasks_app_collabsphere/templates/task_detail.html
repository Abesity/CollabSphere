{% load static %}
<link rel="stylesheet" href="{% static 'css/tasks.css' %}?v=1.0">

<div class="modal fade" id="taskDetailModal" tabindex="-1" aria-labelledby="taskDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <div class="d-flex align-items-center justify-content-between w-100">
          <div class="modal-top-info">
            <h3 class="modal-title" id="taskDetailModalLabel">Task Details</h3>
            <div>
              <span class="task-id">Task #{{ task.task_id|default:"" }}</span>
              <span class="team-id">Team #{{ task.team_id|default:"" }}</span>
            </div>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        {% if not task %}
          <p class="text-danger">Task not found.</p>
        {% else %}
        <form id="taskDetailForm" method="POST" action="{% url 'task_update' task_id=task.task_id %}">
          {% csrf_token %}
          <div class="row">

            <div class="col-md-7 border-end pe-4">
              <div class="mb-3">
                <label for="taskName" class="form-label">Task Name</label>
                <input type="text" id="taskName" name="taskName" class="form-control"
                       required value="{{ task.title|default:'' }}"
                       {% if task.created_by != request.user.username %}disabled{% endif %}>
                <div class="text-danger small mt-1" id="nameError" style="display:none;">Task name is required.</div>
              </div>

              <div class="mb-3 d-flex align-items-center justify-content-between">
                <div class="w-75 me-3">
                  <label for="assignTo" class="form-label">Assign To</label>
                  <select id="assignTo" name="assignTo" class="form-select"
                          {% if task.created_by != request.user.username %}disabled{% endif %}>
                    <option disabled {% if not task.assigned_to %}selected{% endif %}>Select member</option>
                    {% for member in team_members %}
                      <option value="{{ member.id }}" {% if member.id == task.assigned_to %}selected{% endif %}>{{ member.username }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="priority-section">
                  <input type="checkbox" id="priority" name="priority" class="priority-checkbox"
                         {% if task.priority %}checked{% endif %}
                         {% if task.created_by != request.user.username %}disabled{% endif %}>
                  <label for="priority" class="priority-label">Priority</label>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col">
                  <label for="createdBy" class="form-label">Created By</label>
                  <input type="text" id="createdBy" name="createdBy" class="form-control"
                         value="{{ task.created_by|default:request.user.username }}" readonly style="background-color: #e9ecef;">
                </div>
                <div class="col">
                  <label for="dateCreated" class="form-label">Date</label>
                  <input type="date" id="dateCreated" name="dateCreated" class="form-control"
                         value="{{ task.date_created|default:'' }}" readonly style="background-color: #e9ecef;">
                </div>
              </div>

              <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea id="description" name="description" class="form-control" rows="4"
                          placeholder="Enter task details..."
                          {% if task.created_by != request.user.username %}disabled{% endif %}>
{{ task.description|default:'' }}
                </textarea>
              </div>
            </div>

            <div class="col-md-5 ps-4">
              <div class="mb-3">
                <label for="status" class="form-label">Task Status</label>
                <select id="status" name="status" class="form-select"
                        {% if task.created_by != request.user.username %}disabled{% endif %}>
                  <option value="Pending" {% if task.status == "Pending" %}selected{% endif %}>Pending</option>
                  <option value="In Progress" {% if task.status == "In Progress" %}selected{% endif %}>In Progress</option>
                  <option value="Completed" {% if task.status == "Completed" %}selected{% endif %}>Completed</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="completion" class="form-label">Completion (%)</label>
                <input type="range" id="completion" name="completion" min="0" max="100" step="1"
                       class="form-range" value="{{ task.completion|default:0 }}">
                <div class="text-end"><span id="completionValue">{{ task.completion|default:0 }}</span>%</div>
              </div>

              <div class="mb-3">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="date" id="startDate" name="startDate" class="form-control"
                       value="{{ task.start_date|default:'' }}"
                       {% if task.created_by != request.user.username %}disabled{% endif %}>
              </div>

              <div class="mb-3">
                <label for="dueDate" class="form-label">Due Date</label>
                <input type="date" id="dueDate" name="dueDate" class="form-control"
                       value="{{ task.due_date|default:'' }}"
                       {% if task.created_by != request.user.username %}disabled{% endif %}>
              </div>
            </div>

          </div>
        </form>

        <!-- Comments Section -->
        <div class="comments-section mt-4 border-top pt-4">
          <h5 class="mb-3">Comments</h5>
          
          <div class="comments-list mb-4" style="max-height: 200px; overflow-y: auto;">
            {% for comment in comments %}
            <div class="comment-item mb-3 p-3 border rounded" data-comment-id="{{ comment.comment_id }}">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <strong class="text-primary">{{ comment.username }}</strong>
                <div>
                  <small class="text-muted me-2">{{ comment.created_at|date:"M j, Y g:i A" }}</small>
                  {% if comment.username == request.user.username %}
                    <form class="delete-comment-form d-inline" method="POST" action="{% url 'delete_comment' comment_id=comment.comment_id %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-link text-danger">Delete</button>
                    </form>
                  {% endif %}
                </div>
              </div>
              <p class="mb-0">{{ comment.content }}</p>
            </div>
            {% empty %}
            <p class="text-muted text-center">No comments yet.</p>
            {% endfor %}
          </div>

          <!-- Comment Form Always Enabled -->
          <form id="addCommentForm" method="POST" action="{% url 'add_comment' task_id=task.task_id %}">
            {% csrf_token %}
            <div class="mb-3">
                <label for="commentContent" class="form-label">Add Comment</label>
                <textarea id="commentContent" name="content" class="form-control" rows="3" placeholder="Write a comment..." required></textarea>
            </div>
            <button type="submit" class="btn btn-outline-primary btn-sm">Post Comment</button>
          </form>
        </div>

        <form id="taskDeleteForm" method="POST" action="{% url 'task_delete' task_id=task.task_id %}" onsubmit="return confirm('Delete this task?');">
          {% csrf_token %}
        </form>

        {% endif %}
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        {% if task %}
        <button type="submit" form="taskDetailForm" class="btn btn-primary"
                {% if task.created_by != request.user.username %}disabled{% endif %}>Save Changes</button>
        <button type="submit" form="taskDeleteForm" class="btn btn-danger"
                {% if task.created_by != request.user.username %}disabled{% endif %}>Delete</button>
        {% endif %}
      </div>

    </div>
  </div>
</div>

{% comment %} JAVASCRIPT FOR TASK COMMENTS {% endcomment %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Task detail modal loaded - looking for comment form...');
    const commentForm = document.getElementById('addCommentForm');
    console.log('Comment form found:', commentForm);

    if (commentForm) {
        commentForm.addEventListener('submit', function(e) {
            console.log('Comment form submit event caught!');
            e.preventDefault();
            console.log('Default prevented, proceeding with AJAX...');
            e.stopPropagation(); // Important: prevent event bubbling
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Posting...';
            
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                if (data.success) {
                    // Add the new comment to the list
                    const commentsList = document.querySelector('.comments-list');
                    const noCommentsMsg = commentsList.querySelector('.text-muted.text-center');
                    
                    if (noCommentsMsg) {
                        noCommentsMsg.remove();
                    }
                    
                    const newComment = document.createElement('div');
                    newComment.className = 'comment-item mb-3 p-3 border rounded';
                    newComment.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <strong class="text-primary">${data.username}</strong>
                            <small class="text-muted">${new Date(data.created_at).toLocaleString()}</small>
                        </div>
                        <p class="mb-0">${data.content}</p>
                    `;
                    
          commentsList.appendChild(newComment);

          // If the new comment belongs to the current user, add a delete button
          try {
            if (data.username && data.username === currentUser) {
              // attach data-comment-id if provided
              if (data.comment_id) {
                newComment.setAttribute('data-comment-id', data.comment_id);
              }
              const headerDiv = newComment.querySelector('.d-flex');
              if (headerDiv) {
                const metaDiv = headerDiv.querySelector('div') || headerDiv;
                // Create a delete form that will be intercepted by JS; includes a submit button
                if (data.comment_id) {
                  const delForm = document.createElement('form');
                  delForm.className = 'delete-comment-form d-inline';
                  delForm.method = 'POST';
                  delForm.action = `/tasks/comment/${data.comment_id}/delete/`;

                  const delBtn = document.createElement('button');
                  delBtn.type = 'submit';
                  delBtn.className = 'btn btn-sm btn-link text-danger';
                  delBtn.textContent = 'Delete';

                  delForm.appendChild(delBtn);
                  metaDiv.appendChild(delForm);
                }
              }
            }
          } catch (err) {
            console.error('Error attaching delete form to new comment', err);
          }
                    
                    // Clear the form
                    this.reset();
                    
                    // Scroll to show new comment
                    commentsList.scrollTop = commentsList.scrollHeight;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                alert('Something went wrong. Please try again.');
            });
        });
    }

  // Current logged-in username for client-side checks
  const currentUser = "{{ request.user.username|escapejs }}";

  // Event delegation for delete forms inside comments list
  const commentsList = document.querySelector('.comments-list');
  if (commentsList) {
    commentsList.addEventListener('submit', function(e) {
      const form = e.target.closest('.delete-comment-form');
      if (!form) return;
      e.preventDefault();
      const submitBtn = form.querySelector('button[type="submit"]');
      // derive commentId from form action
      const action = form.getAttribute('action') || '';
      const match = action.match(/\/tasks\/comment\/(\d+)\/delete\//);
      const commentId = match ? match[1] : form.closest('.comment-item')?.getAttribute('data-comment-id');
      if (!commentId) {
        console.error('Could not determine comment id for delete form', form);
        return;
      }

      if (!confirm('Delete this comment?')) return;

      if (submitBtn) submitBtn.disabled = true;

      const formData = new FormData(form);
      // Ensure CSRF token header is present
      fetch(action, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        if (data.error) {
          alert('Error: ' + data.error);
          if (submitBtn) submitBtn.disabled = false;
          return;
        }
        if (data.success) {
          // Ensure server-side deletion persisted and refresh the page to show canonical state
          window.location.reload();
          return;
        }
      })
      .catch(err => {
        console.error('Delete comment error', err);
        if (submitBtn) submitBtn.disabled = false;
        alert('Failed to delete comment.');
      });
    });
  }
});

// CSRF token function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
