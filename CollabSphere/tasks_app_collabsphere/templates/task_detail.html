{% load static %}
<link rel="stylesheet" href="{% static 'css/tasks.css' %}?v=1.3">

<div class="modal fade" id="taskDetailModal" tabindex="-1" aria-labelledby="taskDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <div class="d-flex align-items-center justify-content-between w-100">
          <div class="modal-top-info">
            <h3 class="modal-title" id="taskDetailModalLabel">Task Details</h3>
            <div>
              <span class="task-id">Task #{{ task.task_id|default:"" }}</span>
              <span class="team-id">Team #{{ task.team_id|default:"" }}</span>
            </div>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        {% if not task %}
          <p class="text-danger">Task not found.</p>
        {% else %}
        <form id="taskDetailForm" method="POST" action="{% url 'task_update' task_id=task.task_id %}">
          {% csrf_token %}
          <div class="row">

            <div class="col-md-7 border-end pe-4">
              <div class="mb-3">
                <label for="taskName" class="form-label">Task Name</label>
                <input type="text" id="taskName" name="taskName" class="form-control"
                       required value="{{ task.title|default:'' }}"
                       {% if task.created_by != request.user.username %}disabled{% endif %}>
                <div class="text-danger small mt-1" id="nameError" style="display:none;">Task name is required.</div>
              </div>

              <div class="mb-3 d-flex align-items-center justify-content-between">
                <div class="w-75 me-3">
                  <label for="assignTo" class="form-label">Assign To</label>
                  <select id="assignTo" name="assignTo" class="form-select"
                          {% if task.created_by != request.user.username %}disabled{% endif %}>
                    <option disabled {% if not task.assigned_to %}selected{% endif %}>Select member</option>
                    {% for member in team_members %}
                      <option value="{{ member.id }}" {% if member.id == task.assigned_to %}selected{% endif %}>{{ member.username }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="priority-section">
                  <input type="checkbox" id="priority" name="priority" class="priority-checkbox"
                         {% if task.priority %}checked{% endif %}
                         {% if task.created_by != request.user.username %}disabled{% endif %}>
                  <label for="priority" class="priority-label">Priority</label>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col">
                  <label for="createdBy" class="form-label">Created By</label>
                  <input type="text" id="createdBy" name="createdBy" class="form-control"
                         value="{{ task.created_by|default:request.user.username }}" readonly style="background-color: #e9ecef;">
                </div>
                <div class="col">
                  <label for="dateCreated" class="form-label">Date</label>
                  <input type="date" id="dateCreated" name="dateCreated" class="form-control"
                         value="{{ task.date_created|default:'' }}" readonly style="background-color: #e9ecef;">
                </div>
              </div>

              <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea id="description" name="description" class="form-control" rows="4"
                          placeholder="Enter task details..."
                          {% if task.created_by != request.user.username %}disabled{% endif %}>{{ task.description|default:'' }}</textarea>
              </div>
            </div>

            <div class="col-md-5 ps-4">
              <div class="mb-3">
                <label for="status" class="form-label">Task Status</label>
                <select id="status" name="status" class="form-select"
                        {% if task.created_by != request.user.username %}disabled{% endif %}>
                  <option value="Pending" {% if task.status == "Pending" %}selected{% endif %}>Pending</option>
                  <option value="In Progress" {% if task.status == "In Progress" %}selected{% endif %}>In Progress</option>
                  <option value="Completed" {% if task.status == "Completed" %}selected{% endif %}>Completed</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="completion" class="form-label">Completion (%)</label>
                <input type="range" id="completion" name="completion" min="0" max="100" step="1"
                       class="form-range" value="{{ task.completion|default:0 }}">
                <div class="text-end"><span id="completionValue">{{ task.completion|default:0 }}</span>%</div>
              </div>

              <div class="mb-3">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="date" id="startDate" name="startDate" class="form-control"
                       value="{{ task.start_date|default:'' }}"
                       {% if task.created_by != request.user.username %}disabled{% endif %}>
              </div>

              <div class="mb-3">
                <label for="dueDate" class="form-label">Due Date</label>
                <input type="date" id="dueDate" name="dueDate" class="form-control"
                       value="{{ task.due_date|default:'' }}"
                       {% if task.created_by != request.user.username %}disabled{% endif %}>
              </div>
            </div>

          </div>
        </form>

        <!-- Comments Section with Threaded Replies -->
        <div class="comments-section mt-4 border-top pt-4">
          <h5 class="mb-3 comments-heading">Comments</h5>
          
          <div class="comments-list mb-4" id="commentsList">
            {% if comments %}
              {% for comment in comments %}
                <!-- Top-level comment -->
                <div class="comment-item mb-3 p-3 border rounded" data-comment-id="{{ comment.comment_id }}">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <strong class="comment-author">{{ comment.username }}</strong>
                    <div>
                      <small class="text-muted me-2">{{ comment.created_at|date:"M j, Y g:i A" }}</small>
                      {% if comment.username == request.user.username %}
                        <form class="delete-comment-form d-inline" method="POST" action="{% url 'delete_comment' comment_id=comment.comment_id %}">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-sm btn-link text-danger p-0 delete-btn">Delete</button>
                        </form>
                      {% endif %}
                    </div>
                  </div>
                  
                  <p class="mb-0 comment-content">{{ comment.content }}</p>
                  
                  <div class="comment-actions">
                    <button type="button" class="btn btn-sm btn-outline-secondary btn-reply" data-comment-id="{{ comment.comment_id }}">
                      Reply
                    </button>
                  </div>
                  
                  <!-- Reply Form -->
                  <div id="reply-form-{{ comment.comment_id }}" class="reply-form" style="display: none;">
                    <form class="reply-comment-form" method="POST" action="{% url 'add_comment' task_id=task.task_id %}">
                      {% csrf_token %}
                      <input type="hidden" name="parent_id" value="{{ comment.comment_id }}">
                      <div class="mb-2">
                        <textarea name="content" class="form-control form-control-sm" rows="2" placeholder="Write a reply..." required></textarea>
                      </div>
                      <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-sm">Post Reply</button>
                        <button type="button" class="btn btn-secondary btn-sm cancel-reply-btn">Cancel</button>
                      </div>
                    </form>
                  </div>
                  
                  <!-- Level 1 Replies -->
                  {% if comment.replies %}
                    <div class="replies mt-3">
                      {% for reply in comment.replies %}
                        <div class="comment-item mb-3 p-3 border rounded reply-section" data-comment-id="{{ reply.comment_id }}">
                          <div class="d-flex justify-content-between align-items-start mb-2">
                            <strong class="comment-author">{{ reply.username }}</strong>
                            <div>
                              <small class="text-muted me-2">{{ reply.created_at|date:"M j, Y g:i A" }}</small>
                              {% if reply.username == request.user.username %}
                                <form class="delete-comment-form d-inline" method="POST" action="{% url 'delete_comment' comment_id=reply.comment_id %}">
                                  {% csrf_token %}
                                  <button type="submit" class="btn btn-sm btn-link text-danger p-0 delete-btn">Delete</button>
                                </form>
                              {% endif %}
                            </div>
                          </div>
                          
                          <p class="mb-0 comment-content">{{ reply.content }}</p>
                          
                          <div class="comment-actions">
                            <button type="button" class="btn btn-sm btn-outline-secondary btn-reply" data-comment-id="{{ reply.comment_id }}">
                              Reply
                            </button>
                          </div>
                          
                          <!-- Reply Form -->
                          <div id="reply-form-{{ reply.comment_id }}" class="reply-form" style="display: none;">
                            <form class="reply-comment-form" method="POST" action="{% url 'add_comment' task_id=task.task_id %}">
                              {% csrf_token %}
                              <input type="hidden" name="parent_id" value="{{ reply.comment_id }}">
                              <div class="mb-2">
                                <textarea name="content" class="form-control form-control-sm" rows="2" placeholder="Write a reply..." required></textarea>
                              </div>
                              <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary btn-sm">Post Reply</button>
                                <button type="button" class="btn btn-secondary btn-sm cancel-reply-btn">Cancel</button>
                              </div>
                            </form>
                          </div>
                          
                          <!-- Level 2 Replies -->
                          {% if reply.replies %}
                            <div class="replies mt-3">
                              {% for reply2 in reply.replies %}
                                <div class="comment-item mb-3 p-3 border rounded reply-section" data-comment-id="{{ reply2.comment_id }}">
                                  <div class="d-flex justify-content-between align-items-start mb-2">
                                    <strong class="comment-author">{{ reply2.username }}</strong>
                                    <div>
                                      <small class="text-muted me-2">{{ reply2.created_at|date:"M j, Y g:i A" }}</small>
                                      {% if reply2.username == request.user.username %}
                                        <form class="delete-comment-form d-inline" method="POST" action="{% url 'delete_comment' comment_id=reply2.comment_id %}">
                                          {% csrf_token %}
                                          <button type="submit" class="btn btn-sm btn-link text-danger p-0 delete-btn">Delete</button>
                                        </form>
                                      {% endif %}
                                    </div>
                                  </div>
                                  
                                  <p class="mb-0 comment-content">{{ reply2.content }}</p>
                                  
                                  <div class="comment-actions">
                                    <button type="button" class="btn btn-sm btn-outline-secondary btn-reply" data-comment-id="{{ reply2.comment_id }}">
                                      Reply
                                    </button>
                                  </div>
                                  
                                  <!-- Reply Form -->
                                  <div id="reply-form-{{ reply2.comment_id }}" class="reply-form" style="display: none;">
                                    <form class="reply-comment-form" method="POST" action="{% url 'add_comment' task_id=task.task_id %}">
                                      {% csrf_token %}
                                      <input type="hidden" name="parent_id" value="{{ reply2.comment_id }}">
                                      <div class="mb-2">
                                        <textarea name="content" class="form-control form-control-sm" rows="2" placeholder="Write a reply..." required></textarea>
                                      </div>
                                      <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary btn-sm">Post Reply</button>
                                        <button type="button" class="btn btn-secondary btn-sm cancel-reply-btn">Cancel</button>
                                      </div>
                                    </form>
                                  </div>
                                </div>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted text-center no-comments-msg">No comments yet. Be the first to comment!</p>
            {% endif %}
          </div>

          <!-- Main Comment Form -->
          <form id="addCommentForm" class="main-comment-form" method="POST" action="{% url 'add_comment' task_id=task.task_id %}">
            {% csrf_token %}
            <div class="mb-3">
                <label for="commentContent" class="form-label">Add Comment</label>
                <textarea id="commentContent" name="content" class="form-control" rows="3" placeholder="Write a comment..." required></textarea>
            </div>
            <button type="submit" class="btn btn-outline-primary btn-sm">Post Comment</button>
          </form>
        </div>

        <form id="taskDeleteForm" method="POST" action="{% url 'task_delete' task_id=task.task_id %}" onsubmit="return confirm('Delete this task?');">
          {% csrf_token %}
        </form>

        {% endif %}
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        {% if task %}
        <button type="submit" form="taskDetailForm" class="btn btn-primary"
                {% if task.created_by != request.user.username %}disabled{% endif %}>Save Changes</button>
        <button type="submit" form="taskDeleteForm" class="btn btn-danger"
                {% if task.created_by != request.user.username %}disabled{% endif %}>Delete</button>
        {% endif %}
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… Task detail modal script loaded');
    const currentUser = "{{ request.user.username|escapejs }}";
    const commentsList = document.getElementById('commentsList');

    // Handle main comment form
    const commentForm = document.getElementById('addCommentForm');
    if (commentForm) {
        console.log('âœ… Main comment form found');
        commentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('ðŸ“¤ Submitting main comment...');
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Posting...';
            
            const formData = new FormData(this);
            console.log('Form data:', {
                content: formData.get('content'),
                action: this.action
            });
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('ðŸ“¥ Server response:', data);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                if (data.error) {
                    console.error('âŒ Error from server:', data.error);
                    alert('Error: ' + data.error);
                    return;
                }
                
                if (data.success) {
                    console.log('âœ… Comment posted successfully, reloading...');
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('âŒ Fetch error:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                alert('Error details: ' + error.message + '\nCheck console for more info.');
            });
        });
    } else {
        console.error('âŒ Comment form not found!');
    }

    // Handle reply buttons - Simple show/hide
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-reply')) {
            e.preventDefault();
            const commentId = e.target.dataset.commentId;
            console.log('ðŸ’¬ Reply button clicked for comment:', commentId);
            
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            
            if (!replyForm) {
                console.error('âŒ Reply form not found for comment:', commentId);
                alert('Error: Reply form not found. Comment ID: ' + commentId);
                return;
            }
            
            console.log('âœ… Found reply form:', replyForm);
            
            // Hide all other reply forms
            document.querySelectorAll('.reply-form').forEach(form => {
                if (form.id !== `reply-form-${commentId}`) {
                    form.style.display = 'none';
                }
            });
            
            // Toggle this reply form
            if (replyForm.style.display === 'none' || replyForm.style.display === '') {
                replyForm.style.display = 'block';
                console.log('âœ… Reply form shown');
                const textarea = replyForm.querySelector('textarea');
                if (textarea) {
                    setTimeout(() => textarea.focus(), 100);
                    console.log('âœ… Textarea focused');
                }
            } else {
                replyForm.style.display = 'none';
                console.log('âŒ Reply form hidden');
            }
        }
        
        // Handle cancel button
        if (e.target.classList.contains('cancel-reply-btn')) {
            e.preventDefault();
            const replyForm = e.target.closest('.reply-form');
            if (replyForm) {
                replyForm.style.display = 'none';
                const textarea = replyForm.querySelector('textarea');
                if (textarea) textarea.value = '';
                console.log('âŒ Reply form cancelled');
            }
        }
    });

    // Handle reply form submissions
    document.addEventListener('submit', function(e) {
        if (e.target.classList.contains('reply-comment-form')) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('ðŸ“¤ Submitting reply...');
            
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Posting...';
            
            const formData = new FormData(form);
            console.log('Reply form data:', {
                content: formData.get('content'),
                parent_id: formData.get('parent_id'),
                action: form.action
            });
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                console.log('Reply response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('ðŸ“¥ Reply server response:', data);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                if (data.error) {
                    console.error('âŒ Reply error:', data.error);
                    alert('Error: ' + data.error);
                    return;
                }
                
                if (data.success) {
                    console.log('âœ… Reply posted successfully, reloading...');
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('âŒ Reply fetch error:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                alert('Error details: ' + error.message + '\nCheck console for more info.');
            });
        }
    });

    // Event delegation for delete forms
    if (commentsList) {
        commentsList.addEventListener('submit', function(e) {
            const form = e.target.closest('.delete-comment-form');
            if (!form) return;
            
            e.preventDefault();
            
            if (!confirm('Delete this comment? (This will also delete all replies)')) return;
            
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.disabled = true;
            
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    if (submitBtn) submitBtn.disabled = false;
                    return;
                }
                if (data.success) {
                    window.location.reload();
                }
            })
            .catch(err => {
                console.error('Delete comment error', err);
                if (submitBtn) submitBtn.disabled = false;
                alert('Failed to delete comment.');
            });
        });
    }
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>