{% load static %}
<link rel="stylesheet" href="{% static 'css/tasks.css' %}?v=1.0">

<div class="modal fade" id="taskDetailModal" tabindex="-1" aria-labelledby="taskDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <div class="d-flex align-items-center justify-content-between w-100">
          <div class="modal-top-info">
            <h3 class="modal-title" id="taskDetailModalLabel">Task Details</h3>
            <div>
              <span class="task-id">Task #{{ task.task_id|default:"" }}</span>
              <span class="team-id">Team #{{ task.team_id|default:"" }}</span>
            </div>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        {% if not task %}
          <p class="text-danger">Task not found.</p>
        {% else %}
        <form id="taskDetailForm" method="POST" action="{% url 'task_update' task_id=task.task_id %}">
          {% csrf_token %}
          <div class="row">

            <div class="col-md-7 border-end pe-4">
              <div class="mb-3">
                <label for="taskName" class="form-label">Task Name</label>
                <input type="text" id="taskName" name="taskName" class="form-control" required value="{{ task.title|default:'' }}">
                <div class="text-danger small mt-1" id="nameError" style="display:none;">Task name is required.</div>
              </div>
              <!-- Teams yet to be implemented, so team_id is always None -->
              <div class="mb-3 d-flex align-items-center justify-content-between">
                <div class="w-75 me-3">
                  <label for="assignTo" class="form-label">Assign To</label>
                  <select id="assignTo" name="assignTo" class="form-select">
                    <option disabled {% if not task.assigned_to %}selected{% endif %}>Select member</option>
                    {% for member in team_members %}
                      <option value="{{ member.id }}" {% if member.id == task.assigned_to %}selected{% endif %}>{{ member.username }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="priority-section">
                  <input type="checkbox" id="priority" name="priority" class="priority-checkbox" {% if task.priority %}checked{% endif %}>
                  <label for="priority" class="priority-label">Priority</label>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col">
                  <label for="createdBy" class="form-label">Created By</label>
                  <input type="text" id="createdBy" name="createdBy" class="form-control" value="{{ task.created_by|default:request.user.username }}" readonly style="background-color: #e9ecef;">
                </div>
                <div class="col">
                  <label for="dateCreated" class="form-label">Date</label>
                  <input type="date" id="dateCreated" name="dateCreated" class="form-control" value="{{ task.date_created|default:'' }}" readonly style="background-color: #e9ecef;">
                </div>
              </div>

              <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea id="description" name="description" class="form-control" rows="4" placeholder="Enter task details...">{{ task.description|default:'' }}</textarea>
              </div>
            </div>

            <div class="col-md-5 ps-4">
              <div class="mb-3">
                <label for="status" class="form-label">Task Status</label>
                <select id="status" name="status" class="form-select">
                  <option value="Pending" {% if task.status == "Pending" %}selected{% endif %}>Pending</option>
                  <option value="In Progress" {% if task.status == "In Progress" %}selected{% endif %}>In Progress</option>
                  <option value="Completed" {% if task.status == "Completed" %}selected{% endif %}>Completed</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="completion" class="form-label">Completion (%)</label>
                <input type="range" id="completion" name="completion" min="0" max="100" step="1" class="form-range" value="{{ task.completion|default:0 }}">
                <div class="text-end"><span id="completionValue">{{ task.completion|default:0 }}</span>%</div>
              </div>

              <div class="mb-3">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="date" id="startDate" name="startDate" class="form-control" value="{{ task.start_date|default:'' }}">
              </div>

              <div class="mb-3">
                <label for="dueDate" class="form-label">Due Date</label>
                <input type="date" id="dueDate" name="dueDate" class="form-control" value="{{ task.due_date|default:'' }}">
              </div>
            </div>

          </div>
        </form>

        <!-- Delete form -->
        <form id="taskDeleteForm" method="POST" action="{% url 'task_delete' task_id=task.task_id %}" onsubmit="return confirm('Delete this task?');">
          {% csrf_token %}
        </form>

        {% endif %}
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        {% if task %}
        <button type="submit" form="taskDetailForm" class="btn btn-primary">Save Changes</button>
        <button type="submit" form="taskDeleteForm" class="btn btn-danger">Delete</button>
        {% endif %}
      </div>

    </div>
  </div>
</div>